<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9067024774549867"
      crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ã€Šä¸‰å›½æ¨¡æ‹Ÿäººç”Ÿã€‹æ˜¯ä¸€ä¸ªç”±AIé©±åŠ¨çš„æ–‡å­—ç­–ç•¥æ²™ç›’æ¸¸æˆã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥ä½“éªŒä»ä¸€ä»‹å¸ƒè¡£åˆ°ç§°éœ¸å¤©ä¸‹çš„å®Œæ•´ä¸‰å›½å¾ç¨‹ï¼Œæ¢ç´¢å¹¿è¢¤çš„ä¸­åå¤§åœ°ï¼Œåšå‡ºä½ çš„é€‰æ‹©ï¼Œä¹¦å†™ä½ çš„ä¼ å¥‡ã€‚">
    <meta name="keywords" content="ä¸‰å›½, æ–‡å­—æ¸¸æˆ, ç­–ç•¥, MUD, AI, æ²™ç›’, ä¹±ä¸–, è§’è‰²æ‰®æ¼”, RPG, äº’åŠ¨æ¼”ä¹‰">
    <meta name="author" content="AIæ²™ç›’ä¸–ç•Œ">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ai-game.jkai.de/">
    <meta property="og:title" content="ä¸‰å›½æ¨¡æ‹Ÿäººç”Ÿ - AIé©±åŠ¨çš„æ²™ç›’ç­–ç•¥æ¼”ä¹‰">
    <meta property="og:description" content="ç½®èº«ä¸‰å›½ä¹±ä¸–ï¼Œä»ç±ç±æ— ååˆ°ä¸€ç»Ÿå¤©ä¸‹ï¼Œä½ çš„æ¯ä¸€æ­¥è°‹ç•¥éƒ½å°†é“¸å°±ç‹¬ä¸€æ— äºŒçš„éœ¸ä¸šã€‚">
    <meta property="og:image" content="https://ai-game.jkai.de/preview-image.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://ai-game.jkai.de/">
    <meta property="twitter:title" content="ä¸‰å›½æ¨¡æ‹Ÿäººç”Ÿ - AIé©±åŠ¨çš„æ²™ç›’ç­–ç•¥æ¼”ä¹‰">
    <meta property="twitter:description" content="ç½®èº«ä¸‰å›½ä¹±ä¸–ï¼Œä»ç±ç±æ— ååˆ°ä¸€ç»Ÿå¤©ä¸‹ï¼Œä½ çš„æ¯ä¸€æ­¥è°‹ç•¥éƒ½å°†é“¸å°±ç‹¬ä¸€æ— äºŒçš„éœ¸ä¸šã€‚">
    <meta property="twitter:image" content="https://ai-game.jkai.de/preview-image.jpg">
    <title>ä¸‰å›½æ¨¡æ‹Ÿäººç”Ÿ - AIæ²™ç›’ä¸–ç•Œ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5A8D9F; /* Soft blue-grey */
            --accent-color: #D6A47C; /* Muted orange-brown */
            --secondary-accent-color: #A3CC91; /* Soft green */
            --bg-dark: #1E2733; /* Darker background */
            --bg-light: #2A3642; /* Lighter background for elements */
            --text-light: #E0E6EB; /* Light text */
            --border-subtle: rgba(90, 141, 159, 0.4); /* Subtler border color */
            --border-strong: var(--primary-color); /* Stronger border for emphasis */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans SC', 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            padding: 15px; /* Slightly reduced overall padding */
            background-image:
                radial-gradient(circle at 15% 25%, rgba(90, 141, 159, 0.08) 0%, transparent 20%),
                radial-gradient(circle at 85% 75%, rgba(214, 164, 124, 0.08) 0%, transparent 20%);
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        .container {
            max-width: 960px; /* Slightly narrower max-width */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 95vh;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            border-radius: 10px; /* Slightly less rounded */
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 25px 15px; /* Reduced padding */
            margin-bottom: 15px; /* Reduced margin */
            position: relative;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border-subtle);
            border-radius: 10px 10px 0 0;
        }
        
        h1 {
            font-size: 2.2rem; /* Slightly smaller font size */
            margin-bottom: 8px;
            color: var(--primary-color);
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1rem; /* Slightly smaller font size */
            color: var(--accent-color);
            opacity: 0.8;
        }
        
        .game-ui {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px; /* Reduced gap */
            flex: 1;
            padding: 15px; /* Reduced padding */
            background: var(--bg-dark);
        }
        
        .game-area {
            background: var(--bg-light);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 20px; /* Reduced padding */
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .scene-container {
            position: relative;
            min-height: 250px; /* Reduced min-height */
            margin-bottom: 20px; /* Reduced margin */
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 7px rgba(0, 0, 0, 0.3);
        }
        
        #scene-img {
            max-width: 100%;
            max-height: 230px; /* Reduced max-height */
            border-radius: 4px;
            object-fit: contain;
            image-rendering: auto;
        }
        
        .story-text {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 18px; /* Reduced padding */
            margin-bottom: 20px; /* Reduced margin */
            font-size: 1rem; /* Slightly smaller font size */
            line-height: 1.7;
            min-height: 130px; /* Reduced min-height */
            box-shadow: inset 0 0 7px rgba(0, 0, 0, 0.4);
            overflow-y: auto;
        }
        
        .choices-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px; /* Reduced gap */
        }
        
        .choice-btn {
            background: var(--bg-dark);
            border: 1px solid var(--primary-color);
            color: var(--text-light);
            padding: 12px 18px; /* Reduced padding */
            border-radius: 6px;
            font-size: 0.9rem; /* Slightly smaller font size */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: left;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        .choice-btn:hover {
            background: var(--primary-color);
            color: var(--bg-dark);
            transform: translateY(-1px); /* More subtle lift */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        }
        
        .choice-btn:active {
            transform: translateY(0);
            background: color-mix(in srgb, var(--primary-color) 80%, black);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .choice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transition: 0.5s ease-out;
        }
        
        .choice-btn:hover::before {
            left: 100%;
        }
        
        .custom-choice-container {
            margin-top: 20px; /* Adjusted margin for custom input area */
            display: flex;
            flex-direction: column;
            gap: 10px; /* Adjusted gap for custom input elements */
            padding-top: 15px; /* Added padding to separate from choices */
            border-top: 1px dashed var(--border-subtle);
        }

        .custom-choice-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 8px; /* Adjusted gap */
        }

        .custom-input-box {
            display: flex;
            gap: 8px; /* Gap between input and button */
        }

        #custom-choice-input {
            flex-grow: 1;
            padding: 10px 12px; /* Adjusted padding */
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            background: var(--bg-dark);
            color: var(--text-light);
            font-size: 0.9rem; /* Adjusted font size */
            outline: none;
            transition: border-color 0.2s ease;
        }

        #custom-choice-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(214, 164, 124, 0.3);
        }

        #submit-custom-choice {
            background: var(--accent-color);
            color: var(--bg-dark);
            border: none;
            padding: 10px 18px; /* Adjusted padding */
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem; /* Adjusted font size */
            transition: background 0.2s ease, transform 0.1s ease;
            white-space: nowrap; /* Prevent button text from wrapping */
        }

        #submit-custom-choice:hover {
            background: color-mix(in srgb, var(--accent-color) 85%, black);
            transform: translateY(-1px);
        }

        #submit-custom-choice:active {
            transform: translateY(0);
            background: color-mix(in srgb, var(--accent-color) 70%, black);
        }
        
        .skill-btn {
            display: flex;
            align-items: center;
            gap: 8px; /* Reduced gap */
            margin-top: 6px; /* Reduced margin */
        }
        
        .stats-panel {
            background: var(--bg-light);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 20px; /* Reduced padding */
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px; /* Reduced gap */
        }
        
        .panel-title {
            font-size: 1.2rem; /* Slightly smaller font size */
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 8px; /* Reduced margin */
            border-bottom: 1px dashed var(--border-subtle);
            padding-bottom: 8px; /* Reduced padding */
            font-weight: 500;
        }
        
        .character-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 15px; /* Reduced padding */
            border: 1px solid var(--primary-color);
        }
        
        .char-header {
            display: flex;
            align-items: center;
            gap: 12px; /* Reduced gap */
            margin-bottom: 12px; /* Reduced margin */
        }
        
        .char-icon {
            width: 50px; /* Slightly smaller */
            height: 50px; /* Slightly smaller */
            border-radius: 50%;
            background: var(--primary-color);
            color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem; /* Adjusted font size */
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .char-name {
            font-size: 1.2rem; /* Slightly smaller font size */
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .health-bar {
            height: 16px; /* Reduced height */
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px; /* Adjusted border-radius */
            margin: 8px 0; /* Reduced margin */
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-accent-color), var(--accent-color));
            border-radius: 8px;
            transition: width 0.4s ease-out;
        }
        
        .health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem; /* Slightly smaller font size */
            color: var(--text-light);
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px; /* Reduced gap */
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 10px; /* Reduced padding */
            border-radius: 5px; /* Slightly less rounded */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-value {
            font-size: 1.2rem; /* Slightly smaller font size */
            color: var(--accent-color);
            font-weight: 600;
            display: block;
            margin-top: 3px; /* Reduced margin */
        }
        
        .skills-container, .inventory-container, .achievement-container, .adventure-log-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 15px; /* Reduced padding */
            margin-bottom: 5px;
        }

        .skills-container { border: 1px solid var(--secondary-accent-color); }
        .inventory-container { border: 1px solid var(--accent-color); }
        .achievement-container { border: 1px solid gold; }
        .adventure-log-container { border: 1px solid var(--primary-color); }

        .scrollable-content {
            max-height: 120px; /* Further reduced height */
            overflow-y: auto;
            padding-right: 6px; /* For scrollbar */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) rgba(0, 0, 0, 0.1);
        }

        .scrollable-content::-webkit-scrollbar {
            width: 6px; /* Thinner scrollbar */
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
            border: 2px solid var(--bg-light);
        }
        
        .skill-list {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Reduced gap */
        }
        
        .skill-item {
            background: rgba(90, 141, 159, 0.1);
            padding: 8px; /* Reduced padding */
            border-radius: 4px; /* Slightly less rounded */
            border-left: 3px solid var(--secondary-accent-color);
        }
        
        .skill-name {
            color: var(--secondary-accent-color);
            margin-bottom: 1px; /* Reduced margin */
            display: flex;
            align-items: center;
            gap: 6px; /* Reduced gap */
            font-weight: 600;
            font-size: 0.9rem; /* Slightly smaller font size */
        }
        
        .skill-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem; /* Slightly smaller font size */
            line-height: 1.4;
        }
        
        .items-grid {
            display: block;
            margin-top: 8px; /* Reduced margin */
        }

        .item-text, .achievement-text {
            padding: 3px 0; /* Reduced padding */
            text-align: left;
            width: 100%;
            font-size: 0.85rem; /* Slightly smaller font size */
            color: rgba(255, 255, 255, 0.8);
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px; /* Reduced margin */
            padding: 12px; /* Reduced padding */
            background: var(--bg-light);
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.85rem; /* Slightly smaller font size */
            color: rgba(255, 255, 255, 0.7);
        }
        
        .status-value {
            font-size: 1.2rem; /* Slightly smaller font size */
            color: var(--accent-color);
            font-weight: 600;
            margin-top: 4px; /* Reduced margin */
        }

        .game-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0; /* Add margin above and below */
            padding: 10px;
            background: var(--bg-light);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
            gap: 15px; /* Added gap for potential multiple buttons */
        }

        .control-btn {
            background: var(--primary-color);
            color: var(--bg-dark);
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease, transform 0.1s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .control-btn:hover {
            background: color-mix(in srgb, var(--primary-color) 85%, black);
            transform: translateY(-1px);
        }

        .control-btn:active {
            transform: translateY(0);
            background: color-mix(in srgb, var(--primary-color) 70%, black);
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 13, 26, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            border-radius: 8px;
        }
        
        .loading.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .loading-spinner {
            width: 40px; /* Slightly smaller */
            height: 40px; /* Slightly smaller */
            border: 4px solid rgba(90, 141, 159, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px; /* Reduced margin */
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1rem; /* Slightly smaller font size */
            color: var(--primary-color);
            text-align: center;
        }
        
        footer {
            text-align: center;
            padding: 15px; /* Reduced padding */
            margin-top: 15px; /* Reduced margin */
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem; /* Slightly smaller font size */
            border-top: 1px dashed var(--border-subtle);
            background: var(--bg-light);
            border-radius: 0 0 10px 10px;
        }
        
        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Even less padding on smallest screens */
            }

            .container {
                border-radius: 0; /* No border-radius on mobile for full width */
                box-shadow: none; /* No box-shadow on mobile */
            }

            header {
                padding: 20px 10px; /* More compact header */
                margin-bottom: 10px;
                border-radius: 0;
            }

            h1 {
                font-size: 1.8rem; /* Smaller title on mobile */
            }
            .subtitle {
                font-size: 0.9rem; /* Smaller subtitle on mobile */
            }

            .game-ui { 
                grid-template-columns: 1fr; 
                padding: 10px; /* More compact overall game UI padding */
                gap: 15px; /* Reduced gap */
            }
            
            .game-area {
                padding: 15px; /* More compact game area padding */
            }

            .scene-container {
                min-height: 200px; /* Further reduced min-height for scene */
                margin-bottom: 15px;
            }

            #scene-img {
                max-height: 180px; /* Adjusted image max-height */
            }

            .story-text {
                padding: 15px; /* More compact story text padding */
                margin-bottom: 15px;
                font-size: 0.95rem; /* Adjusted font size */
                min-height: 100px; /* Adjusted min-height */
            }

            .choices-container { 
                grid-template-columns: 1fr; /* Stack choices vertically */
                gap: 10px; /* Reduced gap */
            }
            
            .choice-btn {
                padding: 12px 15px; /* Adjusted padding */
                font-size: 0.85rem; /* Adjusted font size */
            }

            .custom-choice-container {
                margin-top: 15px; /* Reduced margin on mobile */
                gap: 8px; /* Reduced gap on mobile */
                padding-top: 10px; /* Reduced padding on mobile */
            }
            #custom-choice-input {
                padding: 10px; /* Adjusted padding */
                font-size: 0.85rem; /* Adjusted font size */
                height: auto; /* Allow height to adjust */
            }
            #submit-custom-choice {
                padding: 0 15px; /* Adjusted padding */
                font-size: 0.85rem; /* Adjusted font size */
            }
            .custom-choice-label {
                font-size: 0.8rem; /* Adjusted font size */
                gap: 6px;
            }
            
            .stats-panel {
                padding: 15px; /* More compact stats panel padding */
                gap: 15px; /* Maintained for clarity between sections */
            }

            .panel-title {
                font-size: 1.1rem; /* Smaller panel title */
                margin-bottom: 10px;
            }

            .character-info {
                padding: 12px; /* More compact char info */
            }

            .char-icon {
                width: 45px; /* Even smaller icon */
                height: 45px;
                font-size: 1.4rem;
            }

            .char-name {
                font-size: 1.1rem; /* Smaller char name */
            }

            .health-bar {
                height: 14px; /* Even smaller health bar */
                margin: 6px 0;
            }

            .health-text {
                font-size: 0.65rem; /* Smaller health text */
            }

            .stats-grid {
                gap: 8px; /* Reduced gap */
            }

            .stat-item {
                padding: 8px; /* Reduced padding */
                font-size: 0.8rem; /* Reduced label font size */
            }
            .stat-value {
                font-size: 1.1rem; /* Reduced stat value font size */
            }

            .skills-container, .inventory-container, .achievement-container, .adventure-log-container {
                padding: 12px; /* More compact section padding */
            }

            .scrollable-content {
                max-height: 90px; /* Significantly reduced height on mobile */
                padding-right: 4px; /* Thinner padding for scrollbar */
            }
            .scrollable-content::-webkit-scrollbar {
                width: 4px; /* Even thinner scrollbar */
            }

            .skill-item {
                padding: 6px; /* Reduced padding */
            }
            .skill-name {
                font-size: 0.85rem; /* Adjusted font size */
            }
            .skill-description {
                font-size: 0.7rem; /* Adjusted font size */
            }
            .item-text, .achievement-text {
                font-size: 0.8rem; /* Adjusted font size */
            }

            .status-bar {
                flex-wrap: wrap;
                gap: 10px; /* Reduced gap */
                padding: 10px; /* Reduced padding */
            }
            .status-item {
                font-size: 0.8rem; /* Reduced font size */
            }
            .status-value {
                font-size: 1.1rem; /* Reduced font size */
            }
            
            .game-controls {
                flex-direction: column; /* Stack buttons vertically on mobile */
                gap: 10px;
                margin: 15px 0;
                padding: 10px;
            }
            
            .control-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .api-settings-container {
                padding: 20px;
                margin-top: 20px;
            }
            .api-settings {
                grid-template-columns: 1fr; /* Stack elements on small screens */
            }
            .api-settings input, .api-settings-select, .api-settings button {
                width: 100%; /* Full width for input elements and buttons */
            }
            .api-settings-select {
                margin-bottom: 5px; /* Add slight margin below select on mobile */
            }

            footer {
                padding: 12px; /* Reduced padding */
                font-size: 0.75rem; /* Smaller footer font */
                margin-top: 10px;
                border-radius: 0;
            }
        }

        /* --- PC-specific adjustments (for screens wider than 768px) --- */
        @media (min-width: 769px) {
            #custom-choice-input {
                font-size: 1rem; /* Larger font for PC */
                padding: 12px 15px; /* More comfortable padding for PC */
            }
            #submit-custom-choice {
                font-size: 1rem; /* Larger font for PC button */
                padding: 12px 20px; /* More comfortable padding for PC button */
            }
            .custom-choice-label {
                font-size: 0.95rem; /* Slightly larger label */
            }
            .choices-container {
                gap: 15px; /* Slightly more space between choice buttons on PC */
            }
            .choice-btn {
                padding: 14px 20px; /* More comfortable padding for PC choice buttons */
                font-size: 0.95rem; /* Slightly larger font for PC choice buttons */
            }
            .story-text {
                font-size: 1.05rem; /* Slightly larger story text for PC */
                min-height: 150px; /* More generous height for PC story text */
            }
            .scene-container {
                min-height: 280px; /* More generous height for scene on PC */
                margin-bottom: 25px; /* Slightly more margin below scene on PC */
            }
            #scene-img {
                max-height: 260px; /* More generous image height on PC */
            }
            .stats-panel {
                gap: 20px; /* More space between sections in stats panel on PC */
            }
            .scrollable-content {
                max-height: 150px; /* More height for scrollable content on PC */
            }
            .panel-title {
                font-size: 1.3rem; /* Slightly larger panel title on PC */
            }
            .char-name {
                font-size: 1.3rem; /* Slightly larger char name on PC */
            }
            .stat-value {
                font-size: 1.3rem; /* Slightly larger stat values on PC */
            }
            /* é‡å¼€æŒ‰é’®PCç«¯è°ƒæ•´ */
            .control-btn {
                padding: 12px 25px; /* Increased padding for a larger button */
                font-size: 1rem; /* Larger font size */
                gap: 10px; /* Slightly more space for icon and text */
            }
            .game-controls {
                margin: 20px 0; /* More vertical space on PC */
                padding: 12px; /* Slightly more padding for the container */
            }
        }
    </style>
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DFX8DXLG3F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DFX8DXLG3F');
</script>
<body>
<div class="container">
    <header>
        <h1>ä¸‰å›½æ¨¡æ‹Ÿäººç”Ÿ</h1>
        <p class="subtitle">å¤§æ¨¡å‹æ–‡å­—å¤§å†’é™©</p>
    </header>

    <div class="status-bar">
        <div class="status-item"><span>é“œé’±</span><span class="status-value">50</span></div>
        <div class="status-item"><span>å£°æœ›</span><span class="status-value">0</span></div>
        <div class="status-item"><span>èº«ä»½</span><span class="status-value">å¸ƒè¡£</span></div>
    </div>

    <div class="game-controls">
        <button id="reset-game-btn" class="control-btn reset-btn">ğŸ”„ é‡å¼€å±€åŠ¿</button>
    </div>

    <div class="game-ui">
        <div class="game-area">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">æ­£åœ¨æ¨æ¼”æ–°çš„ä¹±ä¸–...</div>
            </div>
            
            <div class="image-settings-container">
                <h3 class="panel-title">åœºæ™¯å›¾ç‰‡è®¾ç½®</h3>
                <div class="image-settings">
                    <label for="toggle-image-rendering">
                        <input type="checkbox" id="toggle-image-rendering">
                        <span>æ¸²æŸ“åœºæ™¯å›¾ç‰‡</span>
                    </label>
                </div>
                <p id="image-warning-message" class="image-warning" style="display: none;">
                    å‹¾é€‰æ­¤é¡¹å¯èƒ½ä¼šå¢åŠ å›¾ç‰‡åŠ è½½æ—¶é—´ï¼Œå½±å“æ¸¸æˆé€Ÿåº¦ã€‚
                </p>
            </div>

            <div class="scene-container">
                <img id="scene-img" src="" alt="åœºæ™¯å›¾ç‰‡">
            </div>
            <div class="story-text" id="story-text">
                ä½ ä»ä¸€ä¸ªæ‚ é•¿çš„æ¢¦å¢ƒä¸­æƒŠé†’ï¼Œæ˜¯é—»æ‰€æœªé—»çš„å–§åš£ä¸ç¹åã€‚ä½†çœ¼å‰ï¼Œå´æ˜¯ç®€é™‹çš„èŒ…å±‹ã€å¾®å¼±çš„æ²¹ç¯ã€‚çª—å¤–ï¼Œæˆ˜ç«æ¸è¿‘ï¼Œç‹¼çƒŸå››èµ·ï¼Œè¿œæ–¹å±±å³¦åœ¨æš®è‰²ä¸­å½±å½±ç»°ç»°ã€‚ä½ æ„è¯†åˆ°ï¼Œä½ æ¥åˆ°äº†ä¸€ä¸ªåä¸º"æ±‰æœ«ä¸‰å›½"çš„ä¹±ä¸–ã€‚åœ¨è¿™é‡Œï¼Œæ— è®ºæ˜¯å¸ƒè¡£ç™¾å§“è¿˜æ˜¯è±ªæ°åå£«ï¼Œçš†å¯å‡­å€Ÿæ™ºè°‹ä¸æ­¦å‹‡ï¼Œé€é¹¿ä¸­åŸï¼Œé—®é¼å¤©ä¸‹ï¼Œå¼€åˆ›å±äºè‡ªå·±çš„ç››ä¸–ã€‚ä¸€ä¸ªç¥ç§˜çš„å£°éŸ³åœ¨ä½ è„‘æµ·ä¸­å›å“ï¼š"æ­¤ä¹ƒå¤©å‘½æ‰€å½’ï¼Œäº¦æ˜¯æ±ä¹‹æŠ‰æ‹©ã€‚é€‰æ‹©ä½ çš„å‡ºèº«ï¼Œä¹¦å†™ä½ çš„ä¼ å¥‡å§ã€‚"
            </div>
            <div class="choices-container" id="choices-container">
                <button class="choice-btn" data-choice="æ±‰å®¤å®—äº²">ğŸ“œ æ±‰å®¤å®—äº²ï¼Œèº«ä¸–æµ®æ²‰</button>
                <button class="choice-btn" data-choice="åœ°æ–¹è±ªå¼º">ğŸŒ¾ åœ°æ–¹è±ªå¼ºï¼ŒåŠ›è€•å¤©ä¸‹</button>
                <button class="choice-btn" data-choice="è½é­„å£«äºº">ğŸ“š è½é­„å£«äººï¼Œæ»¡è…¹ç»çº¶</button>
                <button class="choice-btn" data-choice="è¡Œå•†ä¹‹å­">ğŸ’° è¡Œå•†ä¹‹å­ï¼Œè´¢è¿äº¨é€š</button>
                <button class="choice-btn" data-choice="æˆ˜ä¹±æµæ°‘">âš”ï¸ æˆ˜ä¹±æµæ°‘ï¼Œä¹±ä¸–æ±‚ç”Ÿ</button>
            </div>
            
            <div class="custom-choice-container">
                <div class="custom-choice-label">
                    <i class="fas fa-pen"></i> æˆ–è‡ªè¡Œå†³å®šè¡ŒåŠ¨ï¼š
                </div>
                <div class="custom-input-box">
                    <input type="text" id="custom-choice-input" placeholder="è¾“å…¥ä½ çš„è¡ŒåŠ¨ï¼ˆå¦‚ï¼šæ‹œè®¿è´¤å£«ã€æ‹›å‹Ÿå…µå’ã€ä¾¦å¯Ÿæ•Œæƒ…...ï¼‰">
                    <button id="submit-custom-choice">æäº¤</button>
                </div>
            </div>
        </div>
        <div class="stats-panel">
            <h2 class="panel-title">è§’è‰²çŠ¶æ€</h2>
            <div class="character-info">
                <div class="char-header">
                    <div class="char-icon">ğŸ‘¤</div>
                    <div id="char-name" class="char-name">æ— åå°å’</div>
                </div>
                <div class="health-bar">
                    <div id="health-bar" class="health-fill"></div>
                    <div id="health-text" class="health-text">ä½“åŠ›: 100/100</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><span>æ­¦åŠ›</span><span id="attack-value" class="stat-value">5</span></div>
                    <div class="stat-item"><span>æ™ºåŠ›</span><span id="defense-value" class="stat-value">5</span></div>
                    <div class="stat-item"><span>ç»Ÿç‡</span><span id="agility-value" class="stat-value">5</span></div>
                    <div class="stat-item"><span>é­…åŠ›</span><span id="charm-value" class="stat-value">5</span></div>
                </div>
            </div>
            <div class="skills-container">
                <h3 class="panel-title">æˆ˜æ³•/è®¡ç­–</h3>
                <div id="skills-list" class="scrollable-content"></div>
            </div>
            <div class="inventory-container">
                <h3 class="panel-title">è¡Œå›Š</h3>
                <div id="items-grid" class="scrollable-content"></div>
            </div>
            <div class="achievement-container">
                <h3 class="panel-title">åŠŸç»©</h3>
                <div id="achievement-list" class="scrollable-content"></div>
            </div>
            <div class="adventure-log-container">
                <h3 class="panel-title">å¤§äº‹è®°</h3>
                <div id="adventure-log" class="scrollable-content"></div>
            </div>
        </div>
    </div>

    <div class="api-settings-container">
        <h3 class="panel-title">AIæ¨¡å‹è®¾ç½®</h3>
        <p id="api-settings-hint" style="font-size: 0.9rem; color: #888; margin-bottom: 15px;">
            ğŸ”’ é»˜è®¤ä½¿ç”¨å®‰å…¨çš„åç«¯APIï¼Œæ— éœ€é…ç½®ã€‚<br>
            å¦‚éœ€ä½¿ç”¨è‡ªå®šä¹‰APIï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼ˆé…ç½®ä»…å­˜äºå‰ç«¯æµè§ˆå™¨ï¼Œæ— éœ€æ‹…å¿ƒæ³„éœ²ï¼‰ï¼š
        </p>
        <div class="api-settings">
            <input type="text" id="api-url-input" placeholder="è‡ªå®šä¹‰API URL (å¯é€‰)">
            <select id="model-input" class="api-settings-select"></select>
            <input type="password" id="api-key-input" placeholder="è‡ªå®šä¹‰API Key (å¯é€‰)">
            <button id="save-api-btn">ä¿å­˜</button>
            <button id="clear-api-btn">æ¸…é™¤</button>
        </div>
    </div>

    <footer>
        äº«å—ä½ çš„æ¸¸æˆ
    </footer>
</div>

    <script>
	
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
			identity: 'å¸ƒè¡£',
            faction: null,
            health: 100,
            maxHealth: 100,
            attack: 5,
            defense: 5,
            agility: 5,
            charm: 5,
            coins: 50,
            reputation: 0,
            level: 1, 
            skills: [
                {
                    name: "åŸºç¡€æ‹³æ³•",
                    description: "åŸºæœ¬æ­¦å­¦æ‹›å¼ï¼Œè¿‘èº«æˆ˜æ–—æ—¶å‘æŒ¥ä½œç”¨",
                    icon: "fa-solid fa-hand-fist"
                },
                {
                    name: "å‡ç¥é™æ°”",
                    description: "å†·é™å¿ƒæ€",
                    icon: "fa-solid fa-wind"
                }
            ],
            items: [],
            achievements: [
                // åŸºç¡€åŠŸç»©
                { id: 'first_choice', text: 'åˆå…¥ä¹±ä¸–: åšå‡ºä½ çš„äººç”ŸæŠ‰æ‹©', unlocked: false },
                { id: 'first_battle', text: 'åˆè¯•åˆ€å…µ: ç¬¬ä¸€æ¬¡äº²ä¸´æ²™åœº', unlocked: false },
                { id: 'first_victory', text: 'é¦–æˆ˜å‘Šæ·: èµ¢å¾—ç¬¬ä¸€åœºå°è§„æ¨¡èƒœåˆ©', unlocked: false },
                { id: 'breakthrough_qi', text: 'å´­éœ²å¤´è§’: åœ¨éƒ¡å¿ä¹¡é‡Œè·å¾—ä¸€å®šåå£°', unlocked: false },
                { id: 'breakthrough_foundation', text: 'ä¸€æ–¹è±ªå¼º: æˆåŠŸå é¢†ä¸€å¿ä¹‹åœ°æˆ–èšæ‹¢ä¸€æ‰¹è¿½éšè€…', unlocked: false },

                // æ¢ç´¢ä¸æœºé‡
                { id: 'found_hidden_cave', text: 'å¥‡é‡è¿­å‡º: å‘ç°ä¸€å¤„éšç§˜çš„æ´çªŸï¼Œå†…è—çç¨€å®ç‰©', unlocked: false }, 
                { id: 'found_ancient_ruin', text: 'å¯»è®¿å¤è¿¹: æ·±å…¥äººè¿¹ç½•è‡³ä¹‹åœ°ï¼Œå‘ç°ä¸€å¤„è’åºŸçš„å¤æˆ˜åœºæˆ–å‰æœé—å€', unlocked: false },
                { id: 'met_mysterious_master', text: 'ä¸‰é¡¾èŒ…åº: å‘ç°å¹¶æˆåŠŸæ‹›å‹Ÿåˆ°ä¸€ä½éšä¸–ä¸å‡ºçš„è´¤æ‰', unlocked: false }, 
                { id: 'survive_miasma_swamp', text: 'åŒ–é™©ä¸ºå¤·: æˆåŠŸç©¿è¶Šå±æœºå››ä¼çš„å±±å²­æˆ–æ²¼æ³½åœ°å¸¦', unlocked: false },

                // è´¢å¯Œä¸èµ„å†
                { id: 'first_spirit_treasure', text: 'å¾—é‡è‰¯é©¹: è·å¾—ä¸€åŒ¹åƒé‡Œé©¬æˆ–ä¸€ä»¶ç¨€ä¸–å…µå™¨', unlocked: false },
                { id: 'rich_man', text: 'å¯Œå¯æ•Œå›½: èšæ‹¢å¤§é‡é’±ç²®ï¼Œè¶³ä»¥æ”¯æ’‘ä¸€æ”¯å†›é˜Ÿ', unlocked: false },
                { id: 'master_alchemist', text: 'å†›éœ€å®˜: ç²¾é€šå†›å¤‡ç”Ÿäº§æˆ–ä¼¤è¯åˆ¶ä½œ', unlocked: false },
                { id: 'spirit_stone_collector', text: 'å±¯ç”°èƒ½æ‰‹: æˆåŠŸå¼€å‘ä¸‰å¤„ä¸åŒç±»å‹çš„å¯Œé¥¶åœŸåœ°', unlocked: false },

                // æˆ˜æ–—ä¸ç­–ç•¥
                { id: 'flawless_victory', text: 'å…µä¸è¡€åˆƒ: åœ¨ä¸æŸä¸€å…µä¸€å’çš„æƒ…å†µä¸‹èµ¢å¾—ä¸€åœºèƒœåˆ©', unlocked: false },
                { id: 'slay_demon_beast', text: 'é˜µæ–©æ•Œå°†: åœ¨ä¸‡å†›ä¹‹ä¸­æ–©æ€æ•Œæ–¹ä¸»å°†', unlocked: false },
                { id: 'master_of_spells', text: 'è¿ç­¹å¸·å¹„: æˆåŠŸç­–åˆ’å¹¶å®æ–½ä¸€é¡¹æ‰­è½¬æˆ˜å±€çš„è®¡è°‹', unlocked: false },
                { id: 'survived_ambush', text: 'çªå‡ºé‡å›´: åœ¨æ•Œå†›çš„é‡é‡åŒ…å›´ä¸­å…¨èº«è€Œé€€', unlocked: false },
                { id: 'first_skill', text: 'å­¦æœ‰æ‰€æˆ: æŒæ¡ä¸€é¡¹å®ç”¨çš„æ­¦è‰ºæˆ–æ²»å›½æ–¹ç•¥', unlocked: false },
                { id: 'skill_master', text: 'ç™¾è‰ºç²¾é€š: æŒæ¡äº”ç§ä¸åŒçš„å†›æ”¿æˆ–æ°‘ç”ŸæŠ€èƒ½', unlocked: false },
                { id: 'sword_master', text: 'ä¸‡äººæ•Œ: ä¸ªäººæ­¦è‰ºè¾¾åˆ°è¶…å‡¡å…¥åœ£çš„å¢ƒç•Œ', unlocked: false },
                { id: 'spell_caster', text: 'å…µæ³•å¤§å®¶: ç²¾é€šã€Šå­™å­å…µæ³•ã€‹ç­‰å…µä¹¦ï¼Œèƒ½å¸ƒä¸‹ç²¾å¦™é˜µå‹', unlocked: false },

                // ç¤¾äº¤ä¸å£°æœ›
                { id: 'high_reputation', text: 'å¨éœ‡ä¸€æ–¹: åœ¨éƒ¡å¿ä¹ƒè‡³å·åŸŸå†…å»ºç«‹å´‡é«˜å¨æœ›', unlocked: false },
                { id: 'sect_elder', text: 'æ‹œå°†å…¥ç›¸: å—åˆ°ä¸€æ–¹è¯¸ä¾¯é‡ç”¨ï¼Œèº«å±…é«˜ä½', unlocked: false },
                { id: 'dao_companion', text: 'å–œç»“è‰¯ç¼˜: ä¸ä¸€ä½ä¸–å®¶å¥³å­æˆ–è´¤è‰¯æ·‘å¥³ç»“ä¸ºè¿ç†', unlocked: false },
                { id: 'peacemaker', text: 'ä»¥å¾·æœäºº: æˆåŠŸè°ƒè§£ä¸¤å¤§ä¸–å®¶æˆ–åœ°æ–¹åŠ¿åŠ›é—´çš„çº·äº‰', unlocked: false },

                // ç‰¹æ®Šä¸éšè—
                { id: 'defy_heavenly_tribulation', text: 'åŠ›æŒ½ç‹‚æ¾œ: åœ¨å¤§å¦å°†å€¾ä¹‹é™…ï¼ŒåŠ›ä¿ç¤¾ç¨·ä¸å¤±', unlocked: false },
                { id: 'ancient_bloodline', text: 'æ˜­çƒˆé—å¿—: ç»§æ‰¿æˆ–å…‰å¤äº†è¡°è½çš„æ±‰å®¤è¡€è„‰', unlocked: false },
                { id: 'uncovered_conspiracy', text: 'æ‹¨ä¹±åæ­£: å‘ç°å¹¶ç“¦è§£äº†ä¸€ä¸ªé¢ è¦†æœçº²çš„å·¨å¤§é˜´è°‹', unlocked: false }
            ],
            adventureLog: [],
            turn: 0,
            currentScene: "start"
        };

        // DOMå…ƒç´ 
        const storyText = document.getElementById('story-text');
        const choicesContainer = document.getElementById('choices-container');
        const sceneImg = document.getElementById('scene-img');
        const loadingOverlay = document.getElementById('loading');
        const charName = document.getElementById('char-name');
        const healthBar = document.getElementById('health-bar');
        const healthText = document.getElementById('health-text');
        const skillsList = document.getElementById('skills-list');
        const apiUrlInput = document.getElementById('api-url-input');
        const modelInput = document.getElementById('model-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiBtn = document.getElementById('save-api-btn');
        const clearApiBtn = document.getElementById('clear-api-btn');
        const coinsEl = document.querySelector('.status-bar .status-item:nth-child(1) .status-value');
        const reputationEl = document.querySelector('.status-bar .status-item:nth-child(2) .status-value');
        const levelEl = document.querySelector('.status-bar .status-item:nth-child(3) .status-value');
        const attackEl = document.getElementById('attack-value');
        const defenseEl = document.getElementById('defense-value');
        const agilityEl = document.getElementById('agility-value');
        const charmEl = document.getElementById('charm-value');
        const itemsGrid = document.getElementById('items-grid');
        const achievementList = document.getElementById('achievement-list');
        const adventureLogEl = document.getElementById('adventure-log');
        const customChoiceInput = document.getElementById('custom-choice-input');
        const submitCustomChoiceBtn = document.getElementById('submit-custom-choice');
		
		let enableImageRendering = false;

		const toggleImageRenderingCheckbox = document.getElementById('toggle-image-rendering');
		toggleImageRenderingCheckbox.addEventListener('change', () => {
			enableImageRendering = toggleImageRenderingCheckbox.checked;
			const warningMessage = document.getElementById('image-warning-message');
			warningMessage.style.display = enableImageRendering ? 'block' : 'none';
		});


        // ä¿å­˜æ¸¸æˆçŠ¶æ€
        function saveGameState() {
            try {
                // ä¿å­˜å½“å‰çš„é€‰æ‹©æŒ‰é’®
                const currentChoices = [];
                const choiceButtons = choicesContainer.querySelectorAll('.choice-btn');
                choiceButtons.forEach(btn => {
                    currentChoices.push({
                        text: btn.textContent,
                        target: btn.dataset.choice
                    });
                });

                const saveData = {
                    gameState: gameState,
                    currentStoryText: storyText.textContent,
                    currentSceneImg: sceneImg.src,
                    currentChoices: currentChoices,
                    saveTime: new Date().toISOString()
                };
                localStorage.setItem('cultivationGameSave', JSON.stringify(saveData));
                console.log('æ¸¸æˆçŠ¶æ€å·²ä¿å­˜');
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
                return false;
            }
        }

        // åŠ è½½æ¸¸æˆçŠ¶æ€
        function loadGameState() {
            try {
                const saveData = localStorage.getItem('cultivationGameSave');
                if (!saveData) return false;
                
                const parsed = JSON.parse(saveData);
                if (!parsed.gameState) return false;
                
                // æ¢å¤æ¸¸æˆçŠ¶æ€
                Object.assign(gameState, parsed.gameState);

                // åœ¨åŠ è½½æ—¶æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                if (gameState.health <= 0) {
                    updateUI();
                    storyText.textContent = "ä½ å€’åœ¨è¡€æ³Šä¹‹ä¸­ï¼Œæ„è¯†é€æ¸æ¨¡ç³Š... ä½ çš„å†’é™©å·²åœ¨æ­¤ç»ˆç»“ã€‚";
                    choicesContainer.innerHTML = '';
                    const restartBtn = document.createElement('button');
                    restartBtn.className = 'choice-btn';
                    restartBtn.textContent = 'ğŸ”„ é‡æ–°å¼€å§‹';
                    restartBtn.onclick = resetGame;
                    choicesContainer.appendChild(restartBtn);
                    choicesContainer.style.gridTemplateColumns = '1fr';
                    console.log('åŠ è½½åˆ°æ¸¸æˆç»“æŸçŠ¶æ€');
                    return true;
                }
                
                // æ¢å¤ç•Œé¢
                if (parsed.currentStoryText) {
                    storyText.textContent = parsed.currentStoryText;
                }
                if (parsed.currentSceneImg && parsed.currentSceneImg !== window.location.href && !parsed.currentSceneImg.includes('undefined')) {
                    sceneImg.src = parsed.currentSceneImg;
                    sceneImg.style.opacity = 1;
                }
                
                // æ¢å¤é€‰æ‹©æŒ‰é’®
                if (parsed.currentChoices && Array.isArray(parsed.currentChoices)) {
                    choicesContainer.innerHTML = '';
                    parsed.currentChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.dataset.choice = choice.target;
                        button.textContent = choice.text;
                        choicesContainer.appendChild(button);
                    });
                }
                
                updateUI();
                console.log('æ¸¸æˆçŠ¶æ€å·²åŠ è½½ï¼Œä¿å­˜æ—¶é—´:', parsed.saveTime);
                return true;
            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
                return false;
            }
        }

        // é‡ç½®æ¸¸æˆ
        async function resetGame() {
            if (confirm('ç¡®å®šè¦é‡å¼€ä¸€å±€å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è¿›åº¦ï¼Œæ— æ³•æ¢å¤ï¼Œå¤©ä¸‹å¤§åŠ¿å°†é‡æ–°æ¨æ¼”ï¼')) {
                // æ¸…é™¤ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
                localStorage.removeItem('cultivationGameSave');

                // é‡ç½®æ¸¸æˆçŠ¶æ€åˆ°åˆå§‹å€¼
                gameState.faction = null;
                gameState.health = 100;
                gameState.maxHealth = 100;
                gameState.attack = 5;
                gameState.defense = 5;
                gameState.agility = 5;
                gameState.charm = 5;
                gameState.coins = 50;
                gameState.reputation = 0;
                gameState.level = 1;
                gameState.skills = [
                    {
                        name: "åŸºç¡€æ‹³æ³•",
                        description: "åŸºæœ¬æ­¦å­¦æ‹›å¼ï¼Œè¿‘èº«æˆ˜æ–—æ—¶å‘æŒ¥ä½œç”¨",
                        icon: "fa-solid fa-hand-fist"
                    },
                    {
                        name: "å‡ç¥é™æ°”",
                        description: "å†·é™å¿ƒæ€",
                        icon: "fa-solid fa-wind"
                    }
                ];
                gameState.items = [];
                gameState.achievements.forEach(ach => ach.unlocked = false);
                gameState.adventureLog = [];
                gameState.turn = 0;
                gameState.currentScene = "start";

                // é‡ç½®ç•Œé¢åˆ°åˆå§‹çŠ¶æ€
                storyText.textContent = 'ä½ ä»ä¸€ä¸ªæ‚ é•¿çš„æ¢¦å¢ƒä¸­æƒŠé†’ï¼Œæ¢¦é‡Œæ˜¯æœªæ¥ä¸–ç•Œçš„å¥‡å·§æ·«æŠ€ï¼Œæ˜¯é—»æ‰€æœªé—»çš„å–§åš£ä¸ç¹åã€‚ä½†çœ¼å‰ï¼Œå´æ˜¯ç®€é™‹çš„èŒ…å±‹ã€å¾®å¼±çš„æ²¹ç¯ã€‚çª—å¤–ï¼Œæˆ˜ç«æ¸è¿‘ï¼Œç‹¼çƒŸå››èµ·ï¼Œè¿œæ–¹å±±å³¦åœ¨æš®è‰²ä¸­å½±å½±ç»°ç»°ã€‚ä½ æ„è¯†åˆ°ï¼Œä½ æ¥åˆ°äº†ä¸€ä¸ªåä¸º"æ±‰æœ«ä¸‰å›½"çš„ä¹±ä¸–ã€‚åœ¨è¿™é‡Œï¼Œæ— è®ºæ˜¯å¸ƒè¡£ç™¾å§“è¿˜æ˜¯è±ªæ°åå£«ï¼Œçš†å¯å‡­å€Ÿæ™ºè°‹ä¸æ­¦å‹‡ï¼Œé€é¹¿ä¸­åŸï¼Œé—®é¼å¤©ä¸‹ï¼Œå¼€åˆ›å±äºè‡ªå·±çš„ç››ä¸–ã€‚ä¸€ä¸ªç¥ç§˜çš„å£°éŸ³åœ¨ä½ è„‘æµ·ä¸­å›å“ï¼š"æ­¤ä¹ƒå¤©å‘½æ‰€å½’ï¼Œäº¦æ˜¯æ±ä¹‹æŠ‰æ‹©ã€‚é€‰æ‹©ä½ çš„å‡ºèº«ï¼Œä¹¦å†™ä½ çš„ä¼ å¥‡å§ã€‚"';

                // é‡ç½®é€‰æ‹©æŒ‰é’®
                choicesContainer.innerHTML = `
                    <button class="choice-btn" data-choice="æ±‰å®¤å®—äº²">ğŸ“œ æ±‰å®¤å®—äº²ï¼Œèº«ä¸–æµ®æ²‰</button>
                    <button class="choice-btn" data-choice="åœ°æ–¹è±ªå¼º">ğŸŒ¾ åœ°æ–¹è±ªå¼ºï¼ŒåŠ›è€•å¤©ä¸‹</button>
                    <button class="choice-btn" data-choice="è½é­„å£«äºº">ğŸ“š è½é­„å£«äººï¼Œæ»¡è…¹ç»çº¶</button>
                    <button class="choice-btn" data-choice="è¡Œå•†ä¹‹å­">ğŸ’° è¡Œå•†ä¹‹å­ï¼Œè´¢è¿äº¨é€š</button>
                    <button class="choice-btn" data-choice="æˆ˜ä¹±æµæ°‘">âš”ï¸ æˆ˜ä¹±æµæ°‘ï¼Œä¹±ä¸–æ±‚ç”Ÿ</button>
                `;

                // é‡ç½®åœºæ™¯å›¾ç‰‡
                const initialImagePrompt = "A panoramic view of ancient China during the Three Kingdoms period, with vast plains, rolling hills, a bustling market town, a fortified military camp, and a serene scholarly retreat, ink wash painting or traditional Chinese painting style.";
                try {
                    await generateImage(initialImagePrompt);
                } catch (error) {
                    console.error("é‡ç½®æ—¶å›¾ç‰‡åŠ è½½å¤±è´¥:", error);
                }

                updateUI();
                alert('æ–°ä¸€å±€ä¹±ä¸–å¾ç¨‹å·²å¼€å¯ï¼');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            apiUrlInput.value = localStorage.getItem('customApiUrl') || '';
            apiKeyInput.value = localStorage.getItem('customApiKey') || '';
            
            await fetchModels();
            
            choicesContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    const button = e.target.closest('button');
                    handleChoice(button.dataset.choice, button.textContent.trim());
                }
            });

            saveApiBtn.addEventListener('click', saveApiSettings);
            clearApiBtn.addEventListener('click', clearApiSettings);
            
            // æ¸¸æˆæ§åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('reset-game-btn').addEventListener('click', resetGame);
            
            // è‡ªå®šä¹‰è¾“å…¥æäº¤äº‹ä»¶
			submitCustomChoiceBtn.addEventListener('click', () => {
				handleCustomChoice();
				customChoiceInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
			});
			
			customChoiceInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') {
				e.preventDefault(); // é˜²æ­¢è¡¨å•é»˜è®¤è¡Œä¸ºï¼ˆå°¤å…¶ç§»åŠ¨ç«¯ï¼‰
				handleCustomChoice();
				customChoiceInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

				// ç§»åŠ¨ç«¯è‡ªåŠ¨å…³é—­é”®ç›˜
				customChoiceInput.blur();
			}
		});
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®
            const isLocalFile = window.location.protocol === 'file:';
            
            // æ›´æ–°APIè®¾ç½®æç¤ºæ–‡æœ¬
            const apiHint = document.getElementById('api-settings-hint');
            if (isLocalFile) {
                apiHint.innerHTML = 'âš ï¸ <strong>æœ¬åœ°æ–‡ä»¶è®¿é—®æ¨¡å¼</strong>ï¼šå¿…é¡»é…ç½®è‡ªå®šä¹‰APIæ‰èƒ½ä½¿ç”¨æ¸¸æˆåŠŸèƒ½ã€‚<br>è¯·å¡«å†™æ‚¨çš„AI APIä¿¡æ¯ï¼ˆé…ç½®ä»…å­˜äºæµè§ˆå™¨æœ¬åœ°ï¼Œå®‰å…¨å¯é ï¼‰ï¼š';
                apiHint.style.color = '#ff6b6b';
                // æ›´æ–°å ä½ç¬¦æ–‡æœ¬
                apiUrlInput.placeholder = 'API URL (å¿…å¡«ï¼Œå¦‚: https://api.openai.com/v1)';
                apiKeyInput.placeholder = 'API Key (å¿…å¡«)';
            }
            
            // å°è¯•åŠ è½½ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
            const hasLoadedSave = loadGameState();
            
            if (!hasLoadedSave) {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œæ˜¾ç¤ºåˆå§‹åœºæ™¯
				/**
                if (!isLocalFile) {
                    showLoading(true);
                }*/
                //const initialImagePrompt = "A vast and mystical Chinese cultivation world, with towering mountains shrouded in mist, a majestic sword sect, a dark shadowy demonic sect, and a tranquil alchemist's pavilion, ink wash painting style";
                   if (enableImageRendering) {
					try {
						await generateImage(initialImagePrompt);
					} catch (error) {
						console.error("åˆå§‹å›¾ç‰‡åŠ è½½å¤±è´¥:", error);
					}
				}
            } else {
                // å¦‚æœåŠ è½½äº†ä¿å­˜çš„çŠ¶æ€ï¼Œä½†æ²¡æœ‰åœºæ™¯å›¾ç‰‡ï¼Œåˆ™ç”Ÿæˆåˆå§‹å›¾ç‰‡
                if (!sceneImg.src || sceneImg.src === window.location.href || sceneImg.src.includes('file://')) {
                    const initialImagePrompt = "A vast and mystical Chinese cultivation world, with towering mountains shrouded in mist, a majestic sword sect, a dark shadowy demonic sect, and a tranquil alchemist's pavilion, ink wash painting style";
                    try {
                        await generateImage(initialImagePrompt);
                    } catch (error) {
                        console.error("åˆå§‹å›¾ç‰‡åŠ è½½å¤±è´¥:", error);
                    }
                }
            }
            
            updateUI();
        });

        // å¤„ç†è‡ªå®šä¹‰è¾“å…¥
        function handleCustomChoice() {
            const customText = customChoiceInput.value.trim();
            if (!customText) {
                alert('è¯·è¾“å…¥ä½ çš„è¡ŒåŠ¨æŒ‡ä»¤');
                return;
            }
            
            // æ·»åŠ åˆ°å¤§äº‹è®°
            gameState.turn++;
            gameState.adventureLog.push({ turn: gameState.turn, entry: `ä½ å†³å®š: ${customText}` });
            updateUI();
            
            // åŠ è½½åœºæ™¯
            loadScene('custom', customText);
        }

        // åŠ è½½åœºæ™¯ - ç°åœ¨å®Œå…¨ç”±AIé©±åŠ¨
        async function loadScene(sceneKey, playerChoiceText = null) {
            showLoading(true);
            
            try {
                const scene = await generateAdventure(sceneKey, playerChoiceText);
                if (!scene) {
                    throw new Error('AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆåœºæ™¯');
                }

                // åœ¨çŠ¶æ€æ›´æ–°åæ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                if (gameState.health <= 0) {
                    updateUI(); // æœ€åä¸€æ¬¡æ›´æ–°UIä»¥æ˜¾ç¤º0 HP
                    storyText.textContent = scene.text + "\n\nä½ çš„æ°”æ¯é€æ¸å¾®å¼±ï¼Œçœ¼å‰ä¸€é»‘ï¼Œæ„è¯†æ²‰å…¥äº†æ— å°½çš„é»‘æš—... ä½ çš„å†’é™©ç»“æŸäº†ã€‚";
                    choicesContainer.innerHTML = '';
                    const restartBtn = document.createElement('button');
                    restartBtn.className = 'choice-btn';
                    restartBtn.textContent = 'ğŸ”„ é‡æ–°å¼€å§‹';
                    restartBtn.onclick = resetGame;
                    choicesContainer.appendChild(restartBtn);
                    choicesContainer.style.gridTemplateColumns = '1fr';
                    showLoading(false);
                    saveGameState(); // ä¿å­˜æ¸¸æˆç»“æŸçš„çŠ¶æ€
                    return;
                }

                gameState.currentScene = sceneKey;
                storyText.textContent = scene.text;
                renderChoices(scene.choices);
                
                // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåå†ä¿å­˜æ¸¸æˆè¿›åº¦
                try {
                    await generateImage(scene.imagePrompt);
                    // åœ¨æ‰€æœ‰DOMæ›´æ–°ï¼ˆåŒ…æ‹¬å›¾ç‰‡ï¼‰å®Œæˆåä¿å­˜æ¸¸æˆè¿›åº¦
                    saveGameState();
                } catch (error) {
                    console.error("å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œä½†ä»ä¿å­˜æ¸¸æˆè¿›åº¦:", error);
                    // å³ä½¿å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä¹Ÿè¦ä¿å­˜æ¸¸æˆè¿›åº¦
                    saveGameState();
                }
				
				updateUI();
            } catch (error) {
                console.error("å†’é™©ç”Ÿæˆå¤±è´¥çš„è¯¦ç»†é”™è¯¯:", error);
                showLoading(false);
                
                let errorMessage = error instanceof Error ? error.message : JSON.stringify(error);
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„æç¤º
                if (errorMessage.includes('timeout') || errorMessage.includes('TIMEOUT')) {
                    alert(`â° è¯·æ±‚è¶…æ—¶ï¼šAIæœåŠ¡å“åº”è¾ƒæ…¢ï¼Œè¯·ç¨åé‡è¯•ã€‚\n\nå»ºè®®ï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. ç¨ç­‰ç‰‡åˆ»åé‡æ–°é€‰æ‹©\n3. å¦‚æŒç»­å‡ºç°ï¼Œå¯å°è¯•åˆ·æ–°é¡µé¢`);
                } else if (errorMessage.includes('API key')) {
                    alert(`ğŸ”‘ APIé…ç½®é”™è¯¯ï¼šè¯·æ£€æŸ¥APIå¯†é’¥è®¾ç½®ã€‚\n\nå¦‚æœä½¿ç”¨é»˜è®¤åç«¯APIï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚\nå¦‚æœä½¿ç”¨è‡ªå®šä¹‰APIï¼Œè¯·æ£€æŸ¥APIè®¾ç½®ã€‚`);
                } else if (errorMessage.includes('500') || errorMessage.includes('502') || errorMessage.includes('503')) {
                    alert(`ğŸ”§ æœåŠ¡å™¨é”™è¯¯ï¼šAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚\n\nå»ºè®®ï¼š\n1. ç¨åé‡è¯•\n2. æ£€æŸ¥APIæœåŠ¡çŠ¶æ€\n3. å¦‚æŒç»­å‡ºç°ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ`);
                } else {
                    alert(`âŒ å†’é™©ç”Ÿæˆå¤±è´¥: ${errorMessage}\n\nè¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. APIè®¾ç½®æ˜¯å¦æ­£ç¡®\n3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯`);
                }
            }
        }

        // ä½¿ç”¨åç«¯APIç”Ÿæˆå†’é™©
        async function generateAdventure(currentSceneKey, playerChoiceText) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®
            const isLocalFile = window.location.protocol === 'file:';
            
            // æœ¬åœ°æ–‡ä»¶è®¿é—®æ—¶å¿…é¡»ä½¿ç”¨è‡ªå®šä¹‰APIï¼Œå¦åˆ™ä¼˜å…ˆä½¿ç”¨åç«¯API
            let useCustomApi = isLocalFile || (localStorage.getItem('customApiUrl') && localStorage.getItem('customApiKey'));
            let model = localStorage.getItem('customModel') || ''; // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä½¿ç”¨åç«¯é»˜è®¤æ¨¡å‹
            
            // æœ¬åœ°è®¿é—®æ—¶å¦‚æœæ²¡æœ‰é…ç½®è‡ªå®šä¹‰APIï¼Œæç¤ºç”¨æˆ·
            if (isLocalFile && (!localStorage.getItem('customApiUrl') || !localStorage.getItem('customApiKey'))) {
                throw new Error('æœ¬åœ°æ–‡ä»¶è®¿é—®æ¨¡å¼éœ€è¦é…ç½®è‡ªå®šä¹‰APIã€‚è¯·åœ¨é¡µé¢ä¸‹æ–¹çš„"APIè®¾ç½®"ä¸­å¡«å†™æ‚¨çš„API URLå’Œå¯†é’¥ã€‚');
            }
            
            const previousSceneText = storyText.textContent;
            
            // ä¿®æ”¹æç¤ºè¯ï¼Œå¼ºè°ƒç”Ÿå‘½å€¼åªåœ¨æˆ˜æ–—æ—¶å˜åŒ–
            const prompt = `ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„æ–‡å­—å†’é™©æ¸¸æˆå¼•æ“ï¼Œè´Ÿè´£åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè¿è´¯ã€æœ‰è¶£ä¸”èŠ‚å¥åˆç†çš„ä¸‰å›½æ•…äº‹ã€‚ç©å®¶çš„æ€§åˆ«å°†åœ¨æ¸¸æˆå¼€å§‹æ—¶éšæœºç”Ÿæˆï¼Œå¹¶ä¸”åœ¨ç©å®¶é€‰æ‹©å‡ºèº«çš„æ—¶å€™å‘ŠçŸ¥æ€§åˆ«ã€‚æ¨¡æ‹Ÿä¸œæ±‰æœ«å¹´è‡³ä¸‰å›½æ—¶æœŸï¼ˆå…¬å…ƒ184-280å¹´ï¼‰çš„äººç”Ÿå†ç¨‹ï¼Œä»å‡ºç”Ÿåˆ°æ­»äº¡ï¼Œæ¢ç´¢ä¹±ä¸–ã€åˆ¶åº¦ä¸äººæƒ…å¦‚ä½•å¡‘é€ ä¸ªäººå‘½è¿ã€‚ä½“éªŒé»„å·¾èµ·ä¹‰ç­‰å…³é”®å†å²äº‹ä»¶ä¸é‡å¤§æˆ˜å½¹ã€‚

## æ ¸å¿ƒåŸåˆ™ä¸å¾ªç¯æ‰“ç ´ (æœ€é«˜ä¼˜å…ˆçº§)
0.  **ä¸­æ–‡å›å¤:** æ¸¸æˆå†…å®¹å¿…é¡»ä»¥ä¸­æ–‡ç»™å‡ºã€‚
1.  **äº‹ä»¶é©±åŠ¨:** èšç„¦å…·ä½“æˆ˜å½¹ã€è°‹ç•¥ã€å¯¹è¯ã€äººç‰©å…³ç³»ã€å±€åŠ¿æ¼”å˜ã€‚
2.  **å‰§æƒ…æ·±åŒ–:** ä¼˜å…ˆæ‰©å±•å½“å‰äº‹ä»¶ä¸å·²æœ‰è§’è‰²å…³ç³»ï¼Œ**é¿å…è½»æ˜“å¼•å…¥æ–°äººç‰©**ã€‚
3.  **ç³»ç»Ÿæ•´åˆ:** ç©å®¶çš„**æˆ˜æ³•/è®¡ç­–**ï¼ˆ${gameState.skills.map(s => s.name).join('ã€') || 'æ— '}ï¼‰ä¸**ç‰©å“è¡Œå›Š**é¡»è‡ªç„¶åµŒå…¥å‰§æƒ…ä¸é€‰é¡¹ä¸­ã€‚
4.  **å‰§æƒ…æ¨åŠ¨:** æ¯æ®µæ–‡æœ¬ç»“å°¾å¿…é¡»æ¨åŠ¨äº‹æƒ…å‘å±•ï¼Œ**ä¸¥ç¦ä½¿ç”¨å¼•å¯¼è¯­**ã€‚
5.  **ç”Ÿå‘½å€¼è§„åˆ™:** éæˆ˜æ–—ã€éè´Ÿä¼¤ã€éç”Ÿç—…æƒ…èŠ‚**ä¸å¾—å˜æ›´ä½“åŠ› (health)**ã€‚
6.  **å¾ªç¯æ‰“ç ´æœºåˆ¶ (LOOP BREAKER):**
    * åˆ†ææœ€è¿‘5æ¡**å¤§äº‹è®°**ã€‚
    * è¯†åˆ«é‡å¤å¾ªç¯ï¼ˆå¦‚ç¼ æ–—åŒæ•Œã€å›´åŸä¸å…‹ï¼‰ã€‚
    * **å¼ºåˆ¶æ¨è¿›äº‹ä»¶**ï¼ˆæ•Œè´¥ã€æ´å†›ã€å†…è®§ã€å¥‡è°‹çªè¢­ç­‰ï¼‰ã€‚
    * æä¾›**æ–°é˜¶æ®µè¡Œä¸º**ï¼ˆå¦‚â€œæ¸…ç‚¹æˆ˜æœâ€ã€â€œä¼‘æ•´å†›é˜Ÿâ€ã€â€œè½¬æˆ˜ä»–åœ°â€ï¼‰ã€‚
7.  **å…»æˆè§„åˆ™:** 16å²ä¹‹å‰ä¸å‘ç”Ÿæˆ˜æ–—ï¼Œ**ä¸“æ³¨å…»æˆ**ï¼ŒåŒ…æ‹¬äººç‰©å…³ç³»åŸ¹å…»ã€å±æ€§å¢é•¿åŠé“å…·è·å–ã€‚
8.  **ç¦æ­¢åŸåˆ™:** **ä¸¥ç¦å‡ºç°ä»»ä½•ç„å¹»åŠè¶…å‡ºå½“å‰æ—¶ä»£çš„ç§‘æŠ€**ã€‚ä¸¥æ ¼è¾“å‡ºæ¸¸æˆå†…å®¹æè¿°ï¼Œä¸é¢å¤–è§£é‡Šè¯´æ˜ã€‚
9.  **æ£€éªŒåŸåˆ™:** å¯¹ç©å®¶çš„è‡ªå®šä¹‰è¾“å…¥è¿›è¡Œæ ¡éªŒï¼Œ**ä¸å…è®¸è¿åä¸Šè¿°è§„å®š**ã€‚è‹¥è¿åï¼Œåˆ™åˆ¤å®šé€‰æ‹©æ— æ•ˆï¼Œå½“å‰å›åˆç»§ç»­æ¨åŠ¨æ—¶é—´å‘å±•ã€‚

**å‰§æƒ…èŠ‚å¥ä¸æ—¶é—´æµé€:**
- å½“å‰ä¸ºæ¸¸æˆç¬¬ **${gameState.turn} å›åˆ**ï¼Œå³ç©å®¶ **${gameState.age} å²**
- æ¯å›åˆä¸€å¹´ï¼Œå…³é”®äº‹ä»¶ä¸å¾—æ‹–å»¶è¶…è¿‡10å›åˆ

**ç©å®¶æˆé•¿ä¸ç³»ç»Ÿè®¾å®š:**
- **å±æ€§ä½“ç³»:**
    - ä½“åŠ› (Health): æˆ˜æ–—å’Œç‰¹æ®Šäº‹ä»¶æ¶ˆè€—ï¼Œä¸Šé™100ã€‚
    - æ­¦åŠ› (Attack): å½±å“æˆ˜æ–—èƒœè´Ÿã€‚
    - æ™ºåŠ› (Defense): å½±å“è°‹ç•¥æˆåŠŸç‡ï¼Œè®¡ç­–æ•ˆæœã€‚
    - ç»Ÿç‡ (Agility): å½±å“å†›é˜ŸæŒ‡æŒ¥ï¼Œè¡Œå†›é€Ÿåº¦ã€‚
    - é­…åŠ› (Charm): å½±å“æ‹›å‹Ÿäººæ‰ï¼Œå¤–äº¤æˆåŠŸç‡ã€‚
    - é“œé’± (Coins): è´¢å¯Œï¼Œç”¨äºè´­ä¹°ã€å»ºè®¾ã€‚
    - å£°æœ› (Reputation): å½±å“åŠ›ï¼Œè§£é”é«˜é˜¶äº‹ä»¶ï¼Œå½±å“äººè„‰ã€‚
    - èº«ä»½ (Identity): ç©å®¶å½“å‰èº«ä»½ï¼Œå¦‚å¸ƒè¡£ã€ä¼é•¿ã€å¿å°‰ã€éƒ¡å®ˆç­‰ï¼Œä¸å®˜èŒä½“ç³»ç»“åˆã€‚
- **äººç”Ÿé˜¶æ®µï¼š**
  - 0â€“6 å²ï¼ˆå‡ºèº«ï¼‰â†’ ç¡®å®šèµ„æº
  - 7â€“13 å²ï¼ˆå¯è’™ï¼‰â†’ æ±‚å¸ˆå­¦è‰º
  - 14â€“19 å²ï¼ˆå°‘å¹´ï¼‰â†’ ä»å†›ã€äº¤å‹ã€æ‹©ä¸»
  - 20â€“40 å²ï¼ˆå£®å¹´ï¼‰â†’ å°ä¾¯ã€æŒæƒã€å¾æˆ˜ã€è”å§»
  - 41â€“60 å²ï¼ˆç››å¹´ï¼‰â†’ æ‰¶ä¸»ã€ä¼ æ‰¿ã€å½’éš
  - 60+ å²ï¼ˆè€å¹´ï¼‰â†’ è°‹åäº‹ã€ç»ˆç»“å±€
  
ã€æ ¸å¿ƒç³»ç»Ÿã€‘
A) äº‰é›„ï¼ˆå†›äº‹çº¿ï¼‰ï¼šåº”å¾å…¥ä¼/å‹Ÿå…µèµ·äº‹/ä¾é™„å†›é˜€ã€‚éœ€ç»è¥èµ„æºï¼Œå‡­æˆ˜åŠŸæ™‹å‡
B) è°‹å›½ï¼ˆå†…æ”¿çº¿ï¼‰ï¼šæ‹…ä»»å¹•åƒšæˆ–å®˜åï¼Œæ²»ç†è¾–åŒºï¼Œæ¨è¡Œå±¯ç”°ã€‚éœ€å¹³è¡¡æ°‘å¿ƒèµ‹ç¨ä¸äººæ‰
C) çºµæ¨ªï¼ˆå¤–äº¤è°‹ç•¥ï¼‰ï¼šæ¸¸è¯´è¯¸ä¾¯ã€ç¼”ç»“ç›Ÿçº¦ã€è”å§»ç¦»é—´ã€‚éœ€ä¿¡èª‰ä¸æƒ…æŠ¥æ”¯æŒ
D) ä¸–å®¶å¤§æ—ï¼šå®—æ—è”å§»ã€ä¸¾èäººæ‰ã€åœŸåœ°å…¼å¹¶ã€ç®¡ç†éƒ¨æ›²ã€‚é¢ä¸´æ—å†…çº·äº‰ä¸å¤–æ‚£
E) åº¶æ°‘ç”Ÿæ¶¯ï¼šè€•ä½œè´©è¿ã€ç¼´çº³èµ‹ç¨ã€æœå¾­å½¹ã€‚éœ€åº”å¯¹é¥¥è’ç˜Ÿç–«ä¸ç›—åŒªå…µç¥¸
F) æŒšäº¤ä¸æŒšçˆ±ï¼ˆæƒ…æ„Ÿç¾ç»Šï¼‰:åœ¨ä¹±ä¸–ä¸­ï¼ŒçœŸæŒšçš„æƒ…è°Šä¸çˆ±æƒ…èƒ½æˆä¸ºç”Ÿå­˜çš„åŠ¨åŠ›æˆ–è½¯è‚‹ã€‚é€šè¿‡äº’åŠ¨å»ºç«‹æ·±åšå…³ç³»ï¼Œè·å¾—ç‰¹æ®Šæ”¯æŒæˆ–é¢ä¸´æƒ…æ„ŸæŠ‰æ‹©

**å†å²æ¨¡æ‹Ÿä¸èº«ä»½æ¼”å˜æœºåˆ¶ï¼š**
- å…³é”®å†å²äº‹ä»¶å°†éšæ—¶é—´æ¨è¿›ï¼ˆå¦‚é»„å·¾èµ·ä¹‰ã€è‘£å“å…¥äº¬ã€èµ¤å£ä¹‹æˆ˜ï¼‰
- ç©å®¶é€‰æ‹©å¯ä»‹å…¥æˆ–é¿è®©ï¼Œæ¯å¹´æ ¹æ®å›åˆæ¨è¿›æ¼”å˜å±€åŠ¿
- èº«ä»½å¯éšäº‹ä»¶å˜åŒ–ï¼ˆå¦‚å¹³æ°‘ â†’ åå°†å†› â†’ å·ç‰§ â†’ ä¸ç›¸ â†’ å¸ç‹ï¼‰


**ç©å®¶å½“å‰çŠ¶æ€:**
- **èº«ä»½:** ç­‰çº§ ${gameState.level}ï¼ˆå¦‚å¸ƒè¡£ã€å¿å°‰ã€éƒ¡å®ˆã€ä¸ç›¸ã€å¸ç‹ï¼‰
- **å±æ€§:** ä½“åŠ› ${gameState.health}/${gameState.maxHealth}ï¼Œé“œé’± ${gameState.coins}ï¼Œå£°æœ› ${gameState.reputation}
- **æœ€è¿‘å¤§äº‹è®°:** ${gameState.adventureLog.slice(-5).map(log => `å›åˆ ${log.turn}: ${log.entry}`).join('; ') || 'æ— '}
- **å‰æƒ…æè¦:** "${previousSceneText.slice(-250)}"
- **ç©å®¶è¡ŒåŠ¨:** "${playerChoiceText}"

**è¾“å‡ºè§„èŒƒï¼ˆä¸¥æ ¼JSONæ ¼å¼ï¼‰:**
json
{
  "text": "çº¯ç²¹çš„äº‹ä»¶æè¿°(150-300å­—)ã€‚ç»“å°¾ä¸ºé«˜æ½®æˆ–è½¬æŠ˜ã€‚",
  "imagePrompt": "Traditional Chinese painting, Three Kingdoms period, [ä¸'text'å†…å®¹é«˜åº¦ç›¸å…³çš„å…·ä½“åœºæ™¯ã€äººç‰©ã€åŠ¨ä½œå…³é”®è¯]",
  "choices": [
    {"text": "ç¬¦åˆå½“å‰æƒ…æ™¯çš„è¡ŒåŠ¨1", "target": "action_1"},
    {"text": "åŸºäºç©å®¶æˆ˜æ³•æˆ–è®¡ç­–çš„è¡ŒåŠ¨2", "target": "action_2"},
    {"text": "å¯èƒ½æ”¹å˜å½“å‰å±€åŠ¿çš„å†’é™©è¡ŒåŠ¨3", "target": "action_3"}
  ],
 "gameState": {
        "health": <å½“å‰ä½“åŠ›å€¼ï¼Œä¾‹å¦‚ 90>,
        "attack": <å½“å‰æ­¦åŠ›å€¼ï¼Œä¾‹å¦‚ 6>,
        "defense": <å½“å‰æ™ºåŠ›å€¼ï¼Œä¾‹å¦‚ 5>,
        "agility": <å½“å‰ç»Ÿç‡å€¼ï¼Œä¾‹å¦‚ 5>,
        "charm": <å½“å‰é­…åŠ›å€¼ï¼Œä¾‹å¦‚ 5>,
        "coins": <å½“å‰é“œé’±æ•°ï¼Œä¾‹å¦‚ 120>,
        "reputation": <å½“å‰å£°æœ›å€¼ï¼Œä¾‹å¦‚ 10>,
        "identity": "<å½“å‰èº«ä»½ï¼Œä¾‹å¦‚ æ¸¸ä¾ >",
        "skills": [
            {"name": "æ–°è·å¾—çš„æˆ˜æ³•åç§°", "description": "æˆ˜æ³•æè¿°", "icon": "fa-solid fa-star"},
            // ... å…¶ä»–æŠ€èƒ½
        ],
        "items": [
            "æ–°è·å¾—çš„ç‰©å“åç§°",
            // ... å…¶ä»–ç‰©å“
        ],
        "achievements": [
            {"id": "achievement_id", "unlocked": true},
            // ... å…¶ä»–è§£é”çš„æˆå°±
        ]
    },
  "itemUpdates": {"add": [], "remove": []},
  "unlockAchievements": [],
  "logEntry": "å¯¹æœ¬æ¬¡äº‹ä»¶çš„é«˜åº¦æ¦‚æ‹¬ï¼ˆ20å­—ä»¥å†…ï¼‰"
}`;

            let response;
            
            if (useCustomApi) {
                // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„APIè®¾ç½®
                const apiUrl = localStorage.getItem('customApiUrl');
                const apiKey = localStorage.getItem('customApiKey');
                const finalApiUrl = apiUrl.trim() + '/chat/completions';

                response = await fetch(finalApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: prompt }],
                        response_format: { type: "json_object" }
                    })
                });
            } else {
                // ä½¿ç”¨åç«¯APIï¼ˆå®‰å…¨ï¼‰
                response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: model
                    })
                });
            }

            if (!response.ok) {
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${await response.text()}`);
            }

            const data = await response.json();
            console.log("APIè¿”å›çš„åŸå§‹æ•°æ®:", data);
            
            // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
            if (data.usage) {
                console.log("Tokenä½¿ç”¨æƒ…å†µ:", data.usage);
                if (data.usage.completion_tokens >= 3900) {
                    console.warn("è­¦å‘Šï¼šå“åº”æ¥è¿‘tokené™åˆ¶ï¼Œå¯èƒ½è¢«æˆªæ–­");
                }
            }
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘choicesæˆ–messageå­—æ®µ');
            }
            
            let contentString = data.choices[0].message.content;
            console.log("AIè¿”å›çš„åŸå§‹å†…å®¹:", contentString);
            
            if (!contentString || contentString.trim() === '') {
                throw new Error('AIè¿”å›çš„å†…å®¹ä¸ºç©º');
            }
            
            // å°è¯•æå–JSONä»£ç å—
            const match = contentString.match(/```json\s*([\s\S]*?)\s*```/);
            if (match) {
                contentString = match[1];
                console.log("æå–çš„JSONå†…å®¹:", contentString);
            }

            // å°è¯•ä¿®å¤ä¸å®Œæ•´çš„JSON
            function tryFixIncompleteJson(jsonStr) {
				 jsonStr = jsonStr.replace(/undefined/g, 'null')
								  .replace(/<!--[\s\S]*?-->/g, '');
				 jsonStr = jsonStr.trim();
                
                // å°è¯•æ‰¾åˆ°æœ€åä¸€ä¸ªæœ‰æ•ˆçš„JSONå­—ç¬¦ï¼ˆ'}' æˆ– ']' æˆ– '"'ï¼‰
                const lastBrace = jsonStr.lastIndexOf('}');
                const lastBracket = jsonStr.lastIndexOf(']');
                const lastQuote = jsonStr.lastIndexOf('"');
                const lastNumber = jsonStr.search(/[0-9]\s*$/);

                const lastValidCharIndex = Math.max(lastBrace, lastBracket, lastQuote, lastNumber);

                // å¦‚æœå­—ç¬¦ä¸²åœ¨æœ€åä¸€ä¸ªæœ‰æ•ˆå­—ç¬¦åè¿˜æœ‰å†…å®¹ï¼Œè¯´æ˜å¯èƒ½è¢«æˆªæ–­äº†
                if (lastValidCharIndex !== -1 && lastValidCharIndex < jsonStr.length - 1) {
                    // æˆªæ–­åˆ°æœ€åä¸€ä¸ªæœ‰æ•ˆå­—ç¬¦
                    jsonStr = jsonStr.substring(0, lastValidCharIndex + 1);
                }
                
                // é‡æ–°è®¡ç®—æ‹¬å·å’ŒèŠ±æ‹¬å·çš„é…å¹³
                let openBraces = (jsonStr.match(/{/g) || []).length;
                let closeBraces = (jsonStr.match(/}/g) || []).length;
                let openBrackets = (jsonStr.match(/\[/g) || []).length;
                let closeBrackets = (jsonStr.match(/\]/g) || []).length;

                // é—­åˆæœªé—­åˆçš„æ‹¬å·
                while (openBrackets > closeBrackets) {
                    jsonStr += ']';
                    closeBrackets++;
                }
                
                // é—­åˆæœªé—­åˆçš„èŠ±æ‹¬å·
                while (openBraces > closeBraces) {
                    jsonStr += '}';
                    closeBraces++;
                }

                return jsonStr;
            }

            try {
                let content;
                try {
                    content = JSON.parse(contentString);
                } catch (firstError) {
                    console.log("é¦–æ¬¡JSONè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤:", firstError.message);
                    const fixedJsonString = tryFixIncompleteJson(contentString);
                    console.log("ä¿®å¤åçš„JSON:", fixedJsonString);
                    content = JSON.parse(fixedJsonString);
                    console.log("ä¿®å¤æˆåŠŸï¼");
                }
                console.log("è§£ææˆåŠŸçš„content:", JSON.stringify(content, null, 2));
                
                // éªŒè¯å¿…éœ€å­—æ®µ
                if (!content.text) {
                    console.warn("è­¦å‘Šï¼šç¼ºå°‘textå­—æ®µï¼Œä½¿ç”¨é»˜è®¤å€¼");
                    content.text = "ä½ ç»§ç»­åœ¨è¿™ä¸ªç¥ç§˜çš„ä¸–ç•Œä¸­æ¢ç´¢...";
                }
                if (!content.imagePrompt) {
                    console.warn("è­¦å‘Šï¼šç¼ºå°‘imagePromptå­—æ®µï¼Œä½¿ç”¨é»˜è®¤å€¼");
                    content.imagePrompt = "A mystical Chinese cultivation world scene";
                }
                if (!content.choices || !Array.isArray(content.choices)) {
                    console.warn("è­¦å‘Šï¼šç¼ºå°‘choiceså­—æ®µï¼Œä½¿ç”¨é»˜è®¤å€¼");
                    content.choices = [
                        { text: "ç»§ç»­æ¢ç´¢", target: "continue" },
                        { text: "ä¼‘æ¯ç‰‡åˆ»", target: "rest" }
                    ];
                }
                if (!content.gameStateUpdates) {
                    content.gameStateUpdates = {};
                }
                if (!content.itemUpdates) {
                    content.itemUpdates = { add: [], remove: [] };
                }
                if (!content.unlockAchievements) {
                    content.unlockAchievements = [];
                }
                if (!content.logEntry) {
                    content.logEntry = "ç»§ç»­å†’é™©...";
                }

		if (content.gameState) {
			const updates = content.gameState;
			
			// ç›´æ¥è®¾ç½®æ•°å€¼å±æ€§
			['health', 'maxHealth', 'attack', 'defense', 'agility', 'charm', 'coins', 'reputation', 'level'].forEach(key => {
				if (updates[key] !== undefined) {
					gameState[key] = Number(updates[key]);
				}
			});
			
			// æ›´æ–°èº«ä»½
			if (updates.identity) {
				gameState.identity = updates.identity;
			}
			
			// æ›´æ–°æŠ€èƒ½åˆ—è¡¨ï¼ˆå®Œå…¨æ›¿æ¢ï¼‰
			if (updates.skills && Array.isArray(updates.skills)) {
				gameState.skills = updates.skills.map(skill => ({
					name: skill.name,
					description: skill.description || "æ–°ä¹ å¾—çš„æŠ€èƒ½",
					icon: skill.icon || "fa-solid fa-star"
				}));
			}
			
			// ä¿®å¤ç‰©å“æ›´æ–°é€»è¾‘ - å¤„ç†å­—ç¬¦ä¸²æ•°ç»„
			if (updates.items && Array.isArray(updates.items)) {
				gameState.items = updates.items.map(item => {
					// å¤„ç†å­—ç¬¦ä¸²å½¢å¼çš„ç‰©å“
					if (typeof item === 'string') {
						return {
							id: item.toLowerCase().replace(/\s/g, '_'),
							name: item
						};
					}
					// å¤„ç†å¯¹è±¡å½¢å¼çš„ç‰©å“
					return {
						id: item.name.toLowerCase().replace(/\s/g, '_'),
						name: item.name
					};
				});
			}
			
			// æ›´æ–°æˆå°±çŠ¶æ€
			if (updates.achievements && Array.isArray(updates.achievements)) {
				updates.achievements.forEach(achUpdate => {
					const achievement = gameState.achievements.find(a => a.id === achUpdate.id);
					if (achievement) {
						achievement.unlocked = achUpdate.unlocked;
					}
				});
			}
		}
                if (content.itemUpdates) {
                    if (content.itemUpdates.add && Array.isArray(content.itemUpdates.add)) {
                        content.itemUpdates.add.forEach(newItemName => {
                            if (typeof newItemName === 'string') {
                                gameState.items.push({ id: newItemName.toLowerCase().replace(/\s/g, '_'), name: newItemName });
                            }
                        });
                    }
                    if (content.itemUpdates.remove) {
                        content.itemUpdates.remove.forEach(itemIdToRemove => {
                            gameState.items = gameState.items.filter(item => item.id !== itemIdToRemove);
                        });
                    }
                }

                if (content.unlockAchievements && Array.isArray(content.unlockAchievements)) {
                    content.unlockAchievements.forEach(achIdToUnlock => {
                        const achievement = gameState.achievements.find(a => a.id === achIdToUnlock);
                        if (achievement && !achievement.unlocked) {
                            achievement.unlocked = true;
                        }
                    });
                }
                
                // è‡ªåŠ¨æ£€æŸ¥æŠ€èƒ½ç›¸å…³æˆå°±
                const skillCount = gameState.skills.length;
                if (skillCount >= 1) {
                    const firstSkillAch = gameState.achievements.find(a => a.id === 'first_skill');
                    if (firstSkillAch && !firstSkillAch.unlocked) {
                        firstSkillAch.unlocked = true;
                        console.log("è§£é”æˆå°±: åˆçª¥é—¨å¾„");
                    }
                }
                if (skillCount >= 5) {
                    const skillMasterAch = gameState.achievements.find(a => a.id === 'skill_master');
                    if (skillMasterAch && !skillMasterAch.unlocked) {
                        skillMasterAch.unlocked = true;
                        console.log("è§£é”æˆå°±: æŠ€è‰ºç²¾æ¹›");
                    }
                }
                
                // æ£€æŸ¥æ³•æœ¯ç±»æŠ€èƒ½æ•°é‡
                const spellSkills = gameState.skills.filter(skill =>
                    skill.name.includes('æœ¯') || skill.name.includes('æ³•') || skill.name.includes('å’’')
                );
                if (spellSkills.length >= 3) {
                    const spellCasterAch = gameState.achievements.find(a => a.id === 'spell_caster');
                    if (spellCasterAch && !spellCasterAch.unlocked) {
                        spellCasterAch.unlocked = true;
                        console.log("è§£é”æˆå°±: æ³•æœ¯å¤§å¸ˆ");
                    }
                }
                
                if(content.logEntry && typeof content.logEntry === 'string') {
                    gameState.turn++;
                    gameState.adventureLog.push({ turn: gameState.turn, entry: content.logEntry });
                }

                updateUI();
                
                return content;
            } catch (e) {
                console.error("JSONè§£æå¤±è´¥:", e);
                console.error("å°è¯•è§£æçš„å†…å®¹:", contentString);
                
                // å°è¯•ä»åŸå§‹å†…å®¹ä¸­æå–æ–‡æœ¬ä¿¡æ¯
                let extractedText = "æŠ±æ­‰ï¼ŒAIå“åº”è§£æå¤±è´¥ã€‚ä½ å‘ç°è‡ªå·±ç«™åœ¨ä¸€ä¸ªç¥ç§˜çš„åœ°æ–¹ï¼Œå‘¨å›´äº‘é›¾ç¼­ç»•ï¼Œä¼¼ä¹æœ‰æ— æ•°çš„å¯èƒ½æ€§ç­‰å¾…ç€ä½ å»æ¢ç´¢ã€‚";
                
                // å°è¯•ä»æˆªæ–­çš„JSONä¸­æå–textå­—æ®µ
                const textMatch = contentString.match(/"text":\s*"([^"]*(?:\\.[^"]*)*)/);
                if (textMatch && textMatch[1]) {
                    extractedText = textMatch[1].replace(/\\"/g, '"').replace(/\n/g, '\n');
                    console.log("ä»æˆªæ–­çš„JSONä¸­æå–åˆ°æ–‡æœ¬:", extractedText);
                }
                
                // å¦‚æœJSONè§£æå¤±è´¥ï¼Œç”Ÿæˆä¸€ä¸ªæ™ºèƒ½çš„fallbackå“åº”
                const fallbackContent = {
                    text: extractedText,
                    imagePrompt: "A mystical Chinese cultivation world with swirling mists and ancient mountains, ink wash painting style",
                    choices: [
                        { text: "ğŸ”„ é‡æ–°å°è¯•", target: "retry" },
                        { text: "ğŸ  è¿”å›èµ·ç‚¹", target: "start" },
                        { text: "ç»§ç»­æ¢ç´¢", target: "continue" }
                    ],
                    gameStateUpdates: {},
                    itemUpdates: { add: [], remove: [] },
                    unlockAchievements: [],
                    logEntry: "é‡åˆ°äº†ä¸€äº›æŠ€æœ¯é—®é¢˜ï¼Œä½†å†’é™©ä»åœ¨ç»§ç»­..."
                };
                
                console.log("ä½¿ç”¨å¤‡ç”¨å“åº”:", fallbackContent);
                return fallbackContent;
            }
        }

        async function generateImage(prompt) {
		
		if (!enableImageRendering) {
        console.log('å›¾ç‰‡æ¸²æŸ“æœªå¼€å¯ï¼Œè·³è¿‡å›¾ç‰‡ç”Ÿæˆã€‚');
        sceneImg.src = '';  // å¯é€‰æ¸…ç©ºå›¾åƒ
        showLoading(false);
        return Promise.resolve(null);
		}

            return new Promise(async (resolve, reject) => {
                try {
                    sceneImg.style.opacity = 0.5;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®
                    const isLocalFile = window.location.protocol === 'file:';
                    let imageUrl;
                    
                    if (isLocalFile) {
                        // æœ¬åœ°æ–‡ä»¶è®¿é—®æ—¶ç›´æ¥ä½¿ç”¨pollinations API
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true&width=800&height=600&model=flux`;
                    } else {
                        // é€šè¿‡åç«¯APIç”Ÿæˆå›¾ç‰‡
                        const response = await fetch('/api/image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                prompt: prompt,
                                width: 800,
                                height: 600,
                                nologo: true,
                                model: 'flux'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`å›¾ç‰‡ç”ŸæˆAPIè¯·æ±‚å¤±è´¥: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        if (!data.success || !data.imageUrl) {
                            throw new Error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
                        }
                        
                        imageUrl = data.imageUrl;
                        console.log('å›¾ç‰‡ç”ŸæˆæˆåŠŸ:', data);
                    }
                    
                    // é¢„åŠ è½½å›¾ç‰‡
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        sceneImg.src = imageUrl;
                        sceneImg.style.opacity = 1;
                        showLoading(false);
                        resolve(imageUrl);
                    };
                    
                    img.onerror = () => {
                        console.error("å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å›¾ç‰‡");
                        // ä½¿ç”¨å¤‡ç”¨å›¾ç‰‡URL
                        const fallbackUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMWExYTJlIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzRlY2RjNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuS/ruS7meS4lueVjO+8muS6kea4uuS7meWcnzwvdGV4dD4KPC9zdmc+';
                        sceneImg.src = fallbackUrl;
                        sceneImg.style.opacity = 1;
                        showLoading(false);
                        resolve(fallbackUrl);
                    };
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('å›¾ç‰‡ç”Ÿæˆé”™è¯¯:', error);
                    // ä½¿ç”¨å¤‡ç”¨å›¾ç‰‡
                    const fallbackUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMWExYTJlIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzRlY2RjNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuS/ruS7meS4lueVjO+8muS6kea4uuS7meWcnzwvdGV4dD4KPC9zdmc+';
                    sceneImg.src = fallbackUrl;
                    sceneImg.style.opacity = 1;
                    showLoading(false);
                    resolve(fallbackUrl);
                }
            });
        }
        
        function renderChoices(choices) {
            choicesContainer.innerHTML = '';
            if (!choices || choices.length === 0) {
                const endButton = document.createElement('button');
                endButton.className = 'choice-btn';
                endButton.textContent = 'æœ¬æ¬¡å†’é™©æš‚å‘Šä¸€æ®µè½ï¼Œåˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹ã€‚';
                endButton.onclick = () => window.location.reload();
                choicesContainer.appendChild(endButton);
                return;
            }
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.dataset.choice = choice.target;
                button.textContent = choice.text;
                choicesContainer.appendChild(button);
            });
        }
        
        function handleChoice(choiceTarget, choiceText) {
            const firstChoiceAch = gameState.achievements.find(a => a.id === 'first_choice');
            if (firstChoiceAch && !firstChoiceAch.unlocked) {
                firstChoiceAch.unlocked = true;
            }
            loadScene(choiceTarget, choiceText);
        }

        function showLoading(show) {
            loadingOverlay.classList.toggle('active', show);
        }

        function updateUI() {
            if (!Array.isArray(gameState.adventureLog)) {
                gameState.adventureLog = [];
            }

            healthBar.style.width = `${(gameState.health / gameState.maxHealth) * 100}%`;
            healthText.textContent = `ä½“åŠ›: ${gameState.health}/${gameState.maxHealth}`;
            coinsEl.textContent = gameState.coins;
            reputationEl.textContent = gameState.reputation;

            // æ›´æ–°èº«ä»½/åœ°ä½æ˜¾ç¤º
            if (gameState.level > 30) {
                levelEl.textContent = 'å¸ç‹';
            } else if (gameState.level > 25) {
                levelEl.textContent = 'ä¸ç›¸/å¤§å°†å†›';
            } else if (gameState.level > 20) {
                levelEl.textContent = 'å·ç‰§/å¤ªå®ˆ';
            } else if (gameState.level > 15) {
                levelEl.textContent = 'éƒ¡å®ˆ/åˆºå²';
            } else if (gameState.level > 10) {
                levelEl.textContent = 'æ ¡å°‰/éƒ½å°‰';
            } else if (gameState.level > 5) {
                levelEl.textContent = 'å¿ä»¤/äº­é•¿';
            } else if (gameState.level > 1) {
                levelEl.textContent = 'ä¹¡ç»…/é‡Œæ­£';
            } else {
                levelEl.textContent = 'å¸ƒè¡£';
            }
            levelEl.title = `ç­‰çº§: ${gameState.level}`;

            attackEl.textContent = gameState.attack;
            defenseEl.textContent = gameState.defense;
            agilityEl.textContent = gameState.agility;
            charmEl.textContent = gameState.charm;

            skillsList.innerHTML = '';
            if (!gameState.skills || gameState.skills.length === 0) {
                skillsList.innerHTML = '<div>å°šæœªä¹ å¾—ä»»ä½•æˆ˜æ³•æˆ–è®¡ç­–</div>';
            } else {
                gameState.skills.forEach(skill => {
                    const skillItem = document.createElement('div');
                    skillItem.className = 'skill-item';
                    skillItem.innerHTML = `<div class="skill-name"><i class="${skill.icon || 'fa-solid fa-book'}"></i> ${skill.name}</div><div class="skill-description">${skill.description}</div>`;
                    skillsList.appendChild(skillItem);
                });
            }

			itemsGrid.innerHTML = '';
            if (!gameState.items || gameState.items.length === 0) {
                itemsGrid.innerHTML = '<div class="list-item">è¡Œå›Šç©ºç©º...</div>';
            } else {
                // åˆå¹¶ç›¸åŒç‰©å“
                const itemMap = new Map();
                gameState.items.forEach(item => {
                    const itemName = typeof item === 'string' ? item : item.name;
                    if (itemMap.has(itemName)) {
                        const existing = itemMap.get(itemName);
                        existing.count += 1;
                    } else {
                        itemMap.set(itemName, {
                            name: itemName,
                            count: 1
                        });
                    }
                });
                
                // æ¸²æŸ“åˆå¹¶åçš„ç‰©å“
                itemMap.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'list-item';
                    itemEl.innerHTML = `
                        <div class="list-icon">
                            <i class="fa-solid fa-box"></i>
                        </div>
                        <div class="list-content">
                            <div class="list-name">
                                ${item.name}
                                <span class="list-count">x${item.count}</span>
                            </div>
                        </div>
                    `;
                    itemsGrid.appendChild(itemEl);
                });
            }

            achievementList.innerHTML = '';
            const unlockedAchievements = gameState.achievements.filter(a => a.unlocked);
            if (unlockedAchievements.length === 0) {
                achievementList.innerHTML = '<div>å°šæ— åŠŸç»©å¯è¨€</div>';
            } else {
                unlockedAchievements.forEach(ach => {
                    const achEl = document.createElement('div');
                    achEl.className = 'achievement-text';
                    achEl.textContent = `â€¢ ${ach.text}`;
                    achievementList.appendChild(achEl);
                });
            }

            adventureLogEl.innerHTML = '';
            if (!gameState.adventureLog || gameState.adventureLog.length === 0) {
                adventureLogEl.innerHTML = '<div>å¤©ä¸‹å¤§äº‹ï¼Œç”±ä½ ä¹¦å†™...</div>';
            } else {
                gameState.adventureLog.slice().reverse().forEach(log => {
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry';
                    logEl.innerHTML = `<span class="log-turn">[å›åˆ ${log.turn}]</span> ${log.entry}`;
                    adventureLogEl.appendChild(logEl);
                });
            }
        }
        
        async function fetchModels() {
            const modelSelect = document.getElementById('model-input');
            modelSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®
                const isLocalFile = window.location.protocol === 'file:';
                let defaultModelName = 'DeepSeek-R1-0528';
                
                // åªæœ‰åœ¨éæœ¬åœ°æ–‡ä»¶è®¿é—®æ—¶æ‰å°è¯•è·å–åç«¯é…ç½®
                if (!isLocalFile) {
                    try {
                        const configResponse = await fetch('/api/config');
                        if (configResponse.ok) {
                            const config = await configResponse.json();
                            defaultModelName = config.defaultModel;
                        }
                    } catch (e) {
                        console.log('æ— æ³•è·å–åç«¯é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    }
                }
                
                // æœ¬åœ°æ–‡ä»¶è®¿é—®æ—¶å¿…é¡»ä½¿ç”¨è‡ªå®šä¹‰API
                let useCustomApi = isLocalFile || (apiUrlInput.value.trim() && apiKeyInput.value.trim());
                let response;
                
                if (useCustomApi && apiUrlInput.value.trim() && apiKeyInput.value.trim()) {
                    // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„APIè®¾ç½®
                    let apiUrl = apiUrlInput.value.trim();
                    let apiKey = apiKeyInput.value.trim();

                    if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
                    const modelsUrl = `${apiUrl}/models`;

                    response = await fetch(modelsUrl, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                } else if (!isLocalFile) {
                    // ä½¿ç”¨åç«¯APIï¼ˆä»…åœ¨éæœ¬åœ°æ–‡ä»¶è®¿é—®æ—¶ï¼‰
                    response = await fetch('/api/models');
                } else {
                    // æœ¬åœ°æ–‡ä»¶è®¿é—®ä½†æ²¡æœ‰é…ç½®API
                    throw new Error('æœ¬åœ°è®¿é—®éœ€è¦é…ç½®è‡ªå®šä¹‰API');
                }

                if (!response.ok) {
                    throw new Error(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                const models = data.data
                    .filter(model => model.id)
                    .sort((a, b) => a.id.localeCompare(b.id));

                // æ·»åŠ é»˜è®¤é€‰é¡¹
                let optionsHtml = isLocalFile ?
                    '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>' :
                    `<option value="">ä½¿ç”¨åç«¯é»˜è®¤æ¨¡å‹ (${defaultModelName})</option>`;
                optionsHtml += models
                    .map(model => `<option value="${model.id}">${model.id}</option>`)
                    .join('');
                
                modelSelect.innerHTML = optionsHtml;
                
                const savedModel = localStorage.getItem('customModel');
                if (savedModel !== null && (savedModel === '' || models.some(m => m.id === savedModel))) {
                    modelSelect.value = savedModel;
                }
            } catch (error) {
                console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                const isLocalFile = window.location.protocol === 'file:';
                if (isLocalFile) {
                    modelSelect.innerHTML = '<option value="">è¯·å…ˆé…ç½®APIè®¾ç½®</option><option value="DeepSeek-R1-0528">DeepSeek-R1-0528</option>';
                } else {
                    modelSelect.innerHTML = `<option value="">ä½¿ç”¨åç«¯é»˜è®¤æ¨¡å‹ (${defaultModelName})</option><option value="DeepSeek-R1-0528">DeepSeek-R1-0528</option>`;
                }
            }
        }

        function saveApiSettings() {
            localStorage.setItem('customApiUrl', apiUrlInput.value);
            localStorage.setItem('customModel', modelInput.value);
            localStorage.setItem('customApiKey', apiKeyInput.value);
            fetchModels();
            alert('APIè®¾ç½®å·²ä¿å­˜!');
        }

        function clearApiSettings() {
            localStorage.removeItem('customApiUrl');
            localStorage.removeItem('customModel');
            localStorage.removeItem('customApiKey');
            apiUrlInput.value = '';
            modelInput.value = '';
            apiKeyInput.value = '';
            alert('APIè®¾ç½®å·²æ¸…é™¤!');
        }
    </script>
</body>
</html>