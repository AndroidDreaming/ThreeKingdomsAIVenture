<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9067024774549867"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="《三国志：乱世争雄》是一个由AI驱动的文字策略游戏。在这里，你将置身于波澜壮阔的三国时代，从一介布衣到称霸一方，招募将领，发展城池，书写你的霸业传奇。">
    <meta name="keywords" content="三国, 文字游戏, 策略, AI, 沙盒, 角色扮演, RPG, 互动小说, 乱世">
    <meta name="author" content="AI沙盒世界">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-game-url.com/"> <meta property="og:title" content="三国志：乱世争雄 - AI驱动的沙盒策略游戏">
    <meta property="og:description" content="穿越至三国乱世，招募群雄，发展势力，以智谋与武力统一天下，你的每一次选择都将影响历史的走向。">
    <meta property="og:image" content="https://your-game-url.com/preview-image-sanguo.jpg"> <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-game-url.com/"> <meta property="twitter:title" content="三国志：乱世争雄 - AI驱动的沙盒策略游戏">
    <meta property="twitter:description" content="穿越至三国乱世，招募群雄，发展势力，以智谋与武力统一天下，你的每一次选择都将影响历史的走向。">
    <meta property="twitter:image" content="https://your-game-url.com/preview-image-sanguo.jpg"> <title>三国志：乱世争雄 - AI沙盒世界</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2jrdWGYoSBM/Qj+a6PzAUu5+K4vQzJ/pL4mWQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 引入中文字体 */
        @font-face {
            font-family: 'LongCang';
            src: url('https://fonts.gstatic.com/s/longcang/v19/HhyaU5mfoSi_gW-t7QgtC0c.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'ZhiMangXing';
            src: url('https://fonts.gstatic.com/s/zhimangxing/v19/uU9ez_h2rlXoYfK_cM_hzM_x0YfL-z0.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        /* 全局样式 */
        body {
            font-family: 'LongCang', cursive, sans-serif; /* 主要文字使用此字体 */
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom right, #2a2a2a, #000); /* 深色渐变背景 */
            color: #e0e0e0; /* 默认文字颜色 */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* 标题部分 */
        header {
            text-align: center;
            padding: 25px 20px;
            background-color: #1a1a1a;
            border-bottom: 2px solid #444; /* 更明显的分割线 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.5); /* 增加阴影 */
        }

        header h1 {
            font-family: 'ZhiMangXing', cursive, sans-serif; /* 标题使用此字体 */
            color: #ffd700; /* 醒目的金色 */
            margin-bottom: 8px;
            font-size: 3.2em; /* 增大标题 */
            text-shadow: 3px 3px 6px rgba(0,0,0,0.9); /* 更深沉的阴影 */
            letter-spacing: 2px; /* 增加字间距 */
        }

        header .subtitle {
            color: #b0b0b0;
            font-size: 1.2em;
            margin-top: 5px;
        }

        /* 主要内容区域 */
        .main-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px; /* 增加组件间距 */
            padding: 25px;
            flex-grow: 1;
            box-sizing: border-box;
        }

        /* 游戏主区域 */
        .game-area {
            flex: 2 1 650px; /* 调整宽度占比 */
            background-color: #1c1c1c; /* 略浅于背景的深色 */
            border: 1px solid #3a3a3a;
            border-radius: 12px; /* 更圆润的边角 */
            padding: 25px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8); /* 更明显的阴影 */
            display: flex;
            flex-direction: column;
            min-height: 550px; /* 最小高度 */
        }

        /* 场景图片容器 */
        .image-container {
            text-align: center;
            margin-bottom: 25px;
            min-height: 220px;
            background-color: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333; /* 图片框边框 */
        }

        .game-image {
            max-width: 100%;
            max-height: 450px; /* 限制图片高度 */
            height: auto;
            border-radius: 8px;
            display: block;
        }

        /* 故事文本区域 */
        .story-text {
            font-size: 1.3em; /* 增大字体 */
            line-height: 1.8; /* 增加行高，提升阅读舒适度 */
            margin-bottom: 25px;
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #666 #2a2a2a; /* 自定义滚动条颜色 */
            text-align: justify; /* 两端对齐 */
        }

        /* 自定义滚动条 */
        .story-text::-webkit-scrollbar,
        .scrollable-content::-webkit-scrollbar {
            width: 10px;
        }

        .story-text::-webkit-scrollbar-track,
        .scrollable-content::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 10px;
        }

        .story-text::-webkit-scrollbar-thumb,
        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: #666; /* 滚动条颜色 */
            border-radius: 10px;
            border: 2px solid #2a2a2a;
        }

        /* 选项按钮容器 */
        .choices-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* 调整最小宽度 */
            gap: 15px; /* 增加按钮间距 */
            margin-top: 25px;
        }

        /* 选项按钮 */
        .choice-btn {
            background-color: #383838; /* 按钮背景色 */
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 15px 20px; /* 增大按钮填充 */
            border-radius: 8px; /* 圆润边角 */
            font-size: 1.2em; /* 增大字体 */
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s; /* 增加动画效果 */
            font-family: 'LongCang', cursive, sans-serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }

        .choice-btn:hover {
            background-color: #4a4a4a;
            border-color: #777;
            transform: translateY(-2px); /* 悬停上浮效果 */
        }

        .choice-btn:active {
            background-color: #2a2a2a;
            border-color: #444;
            transform: translateY(0); /* 点击下沉效果 */
        }

        /* 侧边栏 */
        .sidebar {
            flex: 1 1 350px; /* 调整宽度占比 */
            background-color: #1c1c1c;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            gap: 25px; /* 增加面板间距 */
        }

        /* 侧边栏面板 */
        .panel {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.5); /* 内部阴影 */
        }

        .panel-title {
            color: #ffd700;
            font-family: 'ZhiMangXing', cursive, sans-serif;
            font-size: 1.8em; /* 增大面板标题 */
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #444; /* 更明显的标题下划线 */
            padding-bottom: 8px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }

        /* 顶部状态栏 */
        .status-bar {
            display: flex;
            justify-content: space-around;
            background-color: #1a1a1a;
            border-top: 2px solid #444;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.5); /* 增加阴影 */
        }

        .status-item {
            flex: 1;
            padding: 0 15px;
            font-size: 1.2em; /* 增大字体 */
            color: #bbb;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px; /* 标签和值之间的间距 */
        }

        .status-item span:first-child {
            font-size: 0.9em;
            color: #999;
        }

        .status-item .status-value {
            color: #eee;
            font-weight: bold;
            font-size: 1.1em; /* 增大数值字体 */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* 角色信息面板 */
        .character-info .char-header {
            display: flex;
            align-items: center;
            gap: 15px; /* 增加头像和名称间距 */
            margin-bottom: 15px;
            justify-content: center; /* 居中显示 */
        }

        .character-info .char-icon {
            font-size: 3em; /* 增大图标 */
            color: #ffd700;
        }

        .character-info .char-name {
            font-size: 2.2em; /* 增大名称字体 */
            font-family: 'ZhiMangXing', cursive, sans-serif;
            color: #eee;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
        }

        .health-bar {
            width: 100%;
            height: 25px; /* 增大血条高度 */
            background-color: #555;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .health-fill {
            height: 100%;
            background-color: #dc3545; /* 鲜艳的红色 */
            width: 100%;
            border-radius: 12px;
            transition: width 0.5s ease-in-out;
        }

        .health-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 25px;
            color: #fff;
            font-size: 1em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px; /* 增加属性间距 */
        }

        .stat-item {
            background-color: #2a2a2a;
            padding: 10px 15px; /* 增大填充 */
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.15em;
            color: #c0c0c0;
            border: 1px solid #3d3d3d;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .stat-item .stat-value {
            color: #ffd700; /* 金色数值 */
            font-weight: bold;
            font-size: 1.1em;
        }

        /* 可滚动内容区域（技能、物品、成就、日志） */
        .scrollable-content {
            max-height: 180px; /* 增大高度 */
            overflow-y: auto;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 12px;
            background-color: #2a2a2a;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .skill-item, .item-text, .achievement-text, .adventure-log-entry {
            background-color: #333;
            padding: 10px; /* 增大填充 */
            border-radius: 5px;
            margin-bottom: 8px; /* 增加行间距 */
            font-size: 1em;
            color: #ccc;
            border-left: 3px solid #ffd700; /* 左侧金条 */
            transition: background-color 0.2s;
        }

        .skill-item:hover, .item-text:hover, .achievement-text:hover, .adventure-log-entry:hover {
            background-color: #3d3d3d;
        }

        .skill-item .skill-name {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .skill-item .skill-description {
            font-size: 0.9em;
            color: #bbb;
        }

        .item-text i, .skill-item i {
            margin-right: 8px;
            color: #ffd700;
        }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85); /* 更深的半透明背景 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.8em; /* 增大字体 */
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            font-family: 'ZhiMangXing', cursive, sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .loading-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #ffd700; /* 金色旋转 */
            border-radius: 50%;
            width: 60px; /* 增大加载圈 */
            height: 60px;
            animation: spin 1.2s linear infinite; /* 稍微慢一点 */
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 页脚 */
        footer {
            text-align: center;
            padding: 20px;
            background-color: #1a1a1a;
            border-top: 2px solid #444;
            color: #888;
            font-size: 1em;
            margin-top: auto;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.5);
        }

        /* 响应式布局 */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                align-items: center;
                padding: 20px;
            }

            .game-area, .sidebar {
                flex: none;
                width: 90%;
                max-width: 800px;
                padding: 20px;
            }

            .story-text {
                font-size: 1.2em;
            }

            .choice-btn {
                font-size: 1.1em;
                padding: 12px 15px;
            }

            .header h1 {
                font-size: 2.8em;
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2.5em;
            }

            header .subtitle {
                font-size: 1em;
            }

            .status-bar {
                flex-wrap: wrap;
                padding: 10px;
            }

            .status-item {
                flex: 0 0 50%; /* 每行显示两个状态 */
                margin-bottom: 10px;
                font-size: 1em;
            }

            .game-area, .sidebar {
                width: 95%;
                padding: 15px;
                gap: 20px;
            }

            .story-text {
                font-size: 1.1em;
                padding: 15px;
            }

            .choices-container {
                grid-template-columns: 1fr; /* 在小屏幕上单列显示按钮 */
                gap: 10px;
            }

            .choice-btn {
                font-size: 1em;
                padding: 10px 12px;
            }

            .panel-title {
                font-size: 1.6em;
            }

            .character-info .char-icon {
                font-size: 2.5em;
            }

            .character-info .char-name {
                font-size: 1.8em;
            }

            .health-bar {
                height: 20px;
            }

            .stats-grid {
                gap: 10px;
            }

            .stat-item {
                font-size: 1em;
                padding: 8px 10px;
            }
            .scrollable-content {
                max-height: 150px;
            }
            .loading-spinner {
                width: 40px;
                height: 40px;
            }
            .loading-overlay p {
                font-size: 1.3em;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 15px 10px;
            }
            header h1 {
                font-size: 2em;
            }
            .main-container {
                padding: 10px;
                gap: 15px;
            }
            .game-area, .sidebar {
                padding: 10px;
                gap: 15px;
            }
            .status-item {
                flex: 0 0 100%; /* 在更小的屏幕上每行一个状态 */
                font-size: 0.9em;
            }
            .story-text {
                font-size: 1em;
                padding: 10px;
            }
            .choice-btn {
                font-size: 0.9em;
                padding: 8px 10px;
            }
            .panel-title {
                font-size: 1.4em;
            }
            .character-info .char-name {
                font-size: 1.5em;
            }
            .stat-item {
                font-size: 0.9em;
            }
            .scrollable-content {
                max-height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">正在分析乱世局势...</p>
    </div>

    <header>
        <h1>三国志：乱世争雄</h1>
        <p class="subtitle">一个由AI驱动的沙盒策略游戏</p>
    </header>

    <div class="status-bar">
        <div class="status-item"><span>金钱</span><span class="status-value" id="coins-value">0</span></div>
        <div class="status-item"><span>声望</span><span class="status-value" id="reputation-value">0</span></div>
        <div class="status-item"><span>官职</span><span class="status-value" id="level-value">布衣</span></div>
        <div class="status-item"><span>粮草</span><span class="status-value" id="food-value">0</span></div>
    </div>

    <div class="main-container">
        <div class="game-area">
            <div class="image-container">
                <img src="" alt="游戏场景" class="game-image" id="game-image">
            </div>
            <div class="story-text" id="story-text">
                你从一场混沌的梦境中醒来，耳边是刀剑碰撞的喧嚣与百姓的哀嚎。你意识到，你并非身处于太平盛世，而是来到了一个战火纷飞的年代——东汉末年，群雄并起的三国乱世。在这里，天下分崩离析，民不聊生，而你，将如何在这乱世中立足，成就一番霸业？一个声音在你心中回荡：“此乃天命所归，亦是汝之抉择。选择你的出身，开启你的乱世征途吧。”
            </div>
            <div class="choices-container" id="choices-container">
                <button class="choice-btn" data-choice="humble_villager">🏡 布衣出身，胸怀天下</button>
                <button class="choice-btn" data-choice="exiled_noble">👑 落魄贵族，旧日余晖</button>
                <button class="choice-btn" data-choice="loyal_retainer">⚔️ 忠义之士，为国效力</button>
                <button class="choice-btn" data-choice="cunning_strategist">💡 隐居谋士，智定乾坤</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="panel character-panel">
                <h2 class="panel-title">主公信息</h2>
                <div class="character-info">
                    <div class="char-header">
                        <div class="char-icon">👑</div>
                        <div id="char-name" class="char-name">无名主公</div>
                    </div>
                    <div class="health-bar">
                        <div id="health-bar" class="health-fill"></div>
                        <div id="health-text" class="health-text">兵力: 0/0</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item"><span>武力</span><span id="attack-value" class="stat-value">0</span></div>
                        <div class="stat-item"><span>统率</span><span id="defense-value" class="stat-value">0</span></div>
                        <div class="stat-item"><span>智力</span><span id="agility-value" class="stat-value">0</span></div>
                        <div class="stat-item"><span>政治</span><span id="charm-value" class="stat-value">0</span></div>
                    </div>
                </div>
            </div>

            <div class="panel skills-panel">
                <h3 class="panel-title">将领/策略</h3>
                <div id="skills-list" class="scrollable-content">
                    <div class="item-text">暂无将领或策略</div>
                </div>
            </div>

            <div class="panel inventory-panel">
                <h3 class="panel-title">辎重营</h3>
                <div id="items-grid" class="scrollable-content">
                    <div class="item-text">暂无辎重</div>
                </div>
            </div>

            <div class="panel achievement-panel">
                <h3 class="panel-title">霸业轨迹</h3>
                <div id="achievement-list" class="scrollable-content">
                    <div class="achievement-text">史官尚未提笔...</div>
                </div>
            </div>

            <div class="panel adventure-log-panel">
                <h3 class="panel-title">史官笔记</h3>
                <div id="adventure-log" class="scrollable-content">
                    <div class="adventure-log-entry">你的霸业即将开启...</div>
                </div>
            </div>

            <button class="choice-btn" onclick="resetGame()">🔄 重置游戏</button>
        </div>
    </div>

    <footer>
        由 AI 驱动的三国策略文字游戏
    </footer>

    <script src="test-pollinations.js"></script>
    <script>
        // DOM 元素引用
        const storyText = document.getElementById('story-text');
        const choicesContainer = document.getElementById('choices-container');
        const gameImage = document.getElementById('game-image');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // 状态栏元素
        const coinsEl = document.getElementById('coins-value');
        const reputationEl = document.getElementById('reputation-value');
        const levelEl = document.getElementById('level-value');
        const foodEl = document.getElementById('food-value'); // 新增粮草元素

        // 角色信息面板元素
        const charName = document.getElementById('char-name');
        const healthBar = document.getElementById('health-bar');
        const healthText = document.getElementById('health-text');
        const attackEl = document.getElementById('attack-value');
        const defenseEl = document.getElementById('defense-value');
        const agilityEl = document.getElementById('agility-value');
        const charmEl = document.getElementById('charm-value');

        const skillsList = document.getElementById('skills-list');
        const itemsGrid = document.getElementById('items-grid');
        const achievementList = document.getElementById('achievement-list');
        const adventureLogEl = document.getElementById('adventure-log');

        // 游戏状态
        let gameState = {
            charName: "无名主公",
            faction: null, // 玩家所属势力，如“无名”、“义军”、“曹操势力”等
            health: 1000, // 兵力
            maxHealth: 1000,
            attack: 60,   // 武力
            defense: 60,  // 统率
            agility: 60,  // 智力
            charm: 60,    // 政治
            coins: 500,   // 金钱
            food: 1000,   // 粮草 (新增)
            reputation: 0, // 声望/民心
            level: 1, // 可以代表官职等级，如1-10是地方官，11-20是州牧等
            skills: [ // 初始将领/策略
                {
                    name: "基础步法",
                    description: "简单的步兵操练，提高部队纪律性",
                    icon: "fa-solid fa-person-military-rifle" // 更改图标
                },
                {
                    name: "市井情报",
                    description: "通过市井传闻获取基本信息",
                    icon: "fa-solid fa-magnifying-glass" // 更改图标
                }
            ],
            items: [], // 物品/装备，如“方天画戟”、“赤兔马”、“青囊书”
            achievements: [ // 成就系统
                { id: 'first_choice', text: '乱世初现: 做出你的第一个选择', unlocked: false },
                { id: 'first_battle', text: '初战告捷: 第一次赢得战斗', unlocked: false },
                { id: 'recruit_general', text: '慧眼识珠: 招募第一位将领', unlocked: false },
                { id: 'build_city', text: '开疆拓土: 发展第一座城池', unlocked: false },
                { id: 'unify_province', text: '一统州郡: 统一一个州的所有城池', unlocked: false },
                { id: 'defeat_famous_general', text: '斩将夺旗: 击败一位著名将领', unlocked: false },
                { id: 'diplomatic_alliance', text: '合纵连横: 成功建立外交同盟', unlocked: false },
                { id: 'rich_nation', text: '国富民强: 拥有超过50000金钱', unlocked: false },
                { id: 'grand_strategist', text: '运筹帷幄: 成功策划一次大型战役', unlocked: false },
                { id: 'emperor_coronation', text: '天下归心: 统一全国，登基称帝', unlocked: false }
            ],
            adventureLog: [],
            turn: 0,
            currentScene: "start"
        };

        // 加载游戏状态
        function loadGameState() {
            const savedState = localStorage.getItem('sanguoGameSave');
            if (savedState) {
                gameState = JSON.parse(savedState);
                addLog("游戏进度已加载。");
            } else {
                addLog("开始新的三国征程。");
            }
            updateUI();
            // 确保初始图片在加载时显示
            if (!gameImage.src || gameImage.src.includes('data:image/gif') || gameImage.src.includes('about:blank')) {
                generateImage("A panoramic view of ancient China during the Three Kingdoms period, with distant mountains, a river, and smoke rising from a battlefield, in a traditional Chinese ink painting style.", "三国乱世初始场景");
            }
        }

        // 保存游戏状态
        function saveGameState() {
            localStorage.setItem('sanguoGameSave', JSON.stringify(gameState));
        }

        // 更新 UI
        function updateUI() {
            charName.textContent = gameState.charName || '无名主公'; // 默认名称
            healthBar.style.width = `${(gameState.health / gameState.maxHealth) * 100}%`;
            healthText.textContent = `兵力: ${gameState.health}/${gameState.maxHealth}`; // 兵力

            // 更新金钱、声望、官职和粮草
            coinsEl.textContent = gameState.coins;
            reputationEl.textContent = gameState.reputation;
            levelEl.textContent = getOfficialRank(gameState.level); // 根据等级获取官职
            foodEl.textContent = gameState.food; // 更新粮草

            // 更新属性
            attackEl.textContent = gameState.attack; // 武力
            defenseEl.textContent = gameState.defense; // 统率
            agilityEl.textContent = gameState.agility; // 智力
            charmEl.textContent = gameState.charm;     // 政治

            // 更新技能/将领
            skillsList.innerHTML = '';
            if (gameState.skills.length === 0) {
                skillsList.innerHTML = '<div class="item-text">暂无将领或策略</div>';
            } else {
                gameState.skills.forEach(skill => {
                    const skillItem = document.createElement('div');
                    skillItem.className = 'skill-item';
                    skillItem.innerHTML = `
                        <div class="skill-name"><i class="${skill.icon}"></i> ${skill.name}</div>
                        <div class="skill-description">${skill.description}</div>
                    `;
                    skillsList.appendChild(skillItem);
                });
            }


            // 更新物品/辎重
            itemsGrid.innerHTML = '';
            if (gameState.items.length === 0) {
                itemsGrid.innerHTML = '<div class="item-text">暂无辎重</div>';
            } else {
                gameState.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'item-text';
                    itemElement.textContent = `${item.name} (${item.quantity})`;
                    itemsGrid.appendChild(itemElement);
                });
            }

            // 更新成就/霸业轨迹
            achievementList.innerHTML = '';
            const unlockedAchievements = gameState.achievements.filter(a => a.unlocked);
            if (unlockedAchievements.length === 0) {
                achievementList.innerHTML = '<div class="achievement-text">暂无霸业轨迹</div>';
            } else {
                unlockedAchievements.forEach(ach => {
                    const achElement = document.createElement('div');
                    achElement.className = 'achievement-text';
                    achElement.textContent = `✅ ${ach.text}`;
                    achievementList.appendChild(achElement);
                });
            }

            // 更新冒险日志/史官笔记
            adventureLogEl.innerHTML = '';
            if (gameState.adventureLog.length === 0) {
                adventureLogEl.innerHTML = '<div class="adventure-log-entry">史官尚未提笔...</div>';
            } else {
                gameState.adventureLog.slice().reverse().forEach(log => { // 显示最新日志
                    const logEntry = document.createElement('div');
                    logEntry.className = 'adventure-log-entry';
                    logEntry.textContent = log;
                    adventureLogEl.appendChild(logEntry);
                });
            }

            saveGameState(); // 每次更新UI后保存游戏状态
        }

        // 辅助函数：根据等级获取官职
        function getOfficialRank(level) {
            if (level < 5) return "布衣";
            if (level < 10) return "县令";
            if (level < 15) return "郡守";
            if (level < 20) return "刺史";
            if (level < 25) return "州牧";
            if (level < 30) return "大将军";
            if (level < 35) return "丞相";
            return "天子"; // 最高等级
        }

        // 添加日志
        function addLog(entry) {
            gameState.adventureLog.push(`回合 ${gameState.turn + 1}: ${entry}`);
            // 限制日志条数，例如只保留最新50条
            if (gameState.adventureLog.length > 50) {
                gameState.adventureLog.splice(0, gameState.adventureLog.length - 50);
            }
            updateUI(); // 实时更新日志
        }

        // 显示加载动画
        function showLoading(message) {
            loadingText.textContent = message;
            loadingOverlay.classList.add('visible');
        }

        // 隐藏加载动画
        function hideLoading() {
            loadingOverlay.classList.remove('visible');
        }

        // 更新选项
        function updateChoices(choices) {
            choicesContainer.innerHTML = '';
            if (choices && choices.length > 0) {
                choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = () => handleChoice(choice.target, choice.text);
                    choicesContainer.appendChild(button);
                });
            } else {
                // 如果没有更多选项，提供一个重新开始的按钮
                storyText.textContent += "\n\n乱世无常，前路已断。";
                const restartBtn = document.createElement('button');
                restartBtn.className = 'choice-btn';
                restartBtn.textContent = '🔄 重新开始';
                restartBtn.onclick = resetGame;
                choicesContainer.appendChild(restartBtn);
                choicesContainer.style.gridTemplateColumns = '1fr';
            }
        }

        // 解锁成就
        function unlockAchievement(id) {
            const achievement = gameState.achievements.find(ach => ach.id === id);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                addLog(`恭喜！解锁成就：${achievement.text}`);
                updateUI();
            }
        }

        // 应用AI生成的效果
        function applyEffects(effects) {
            if (!effects) return;
            for (const key in effects) {
                if (gameState.hasOwnProperty(key)) {
                    if (key === 'health') {
                        gameState.health = Math.max(0, Math.min(gameState.maxHealth, gameState.health + effects[key]));
                        addLog(`兵力${effects[key] > 0 ? '增加' : '减少'}了 ${Math.abs(effects[key])}。`);
                    } else if (key === 'maxHealth') {
                        gameState.maxHealth += effects[key];
                        addLog(`最大兵力上限${effects[key] > 0 ? '提升' : '降低'}了 ${Math.abs(effects[key])}。`);
                    }
                    else if (key === 'items' && Array.isArray(effects[key])) {
                        effects[key].forEach(newItem => {
                            const existingItem = gameState.items.find(item => item.name === newItem.name);
                            if (existingItem) {
                                existingItem.quantity = (existingItem.quantity || 1) + (newItem.quantity || 1);
                                addLog(`获得了 ${newItem.quantity || 1} 单位的 ${newItem.name}。`);
                            } else {
                                gameState.items.push({ name: newItem.name, quantity: newItem.quantity || 1 });
                                addLog(`获得了物品：${newItem.name}。`);
                            }
                        });
                    } else if (key === 'skills' && Array.isArray(effects[key])) {
                        effects[key].forEach(newSkill => {
                            if (!gameState.skills.some(s => s.name === newSkill.name)) {
                                gameState.skills.push(newSkill);
                                addLog(`学会了新的将领/策略：${newSkill.name}。`);
                                unlockAchievement('first_skill'); // 学习新技能成就
                            }
                        });
                    } else if (key === 'achievements' && Array.isArray(effects[key])) {
                        effects[key].forEach(achId => unlockAchievement(achId));
                    } else if (key === 'level') { // 官职提升
                        gameState.level += effects[key];
                        addLog(`你的官职提升了！现在是：${getOfficialRank(gameState.level)}。`);
                    } else if (key === 'food') { // 粮草增减
                        gameState.food = Math.max(0, gameState.food + effects[key]);
                        addLog(`粮草${effects[key] > 0 ? '增加' : '减少'}了 ${Math.abs(effects[key])}。`);
                    }
                    else {
                        gameState[key] += effects[key];
                        // 针对不同的属性提供更具体的日志
                        if (key === 'coins') addLog(`金钱${effects[key] > 0 ? '增加' : '减少'}了 ${Math.abs(effects[key])}。`);
                        else if (key === 'reputation') addLog(`声望${effects[key] > 0 ? '提升' : '下降'}了 ${Math.abs(effects[key])}。`);
                        else if (key === 'attack') addLog(`武力${effects[key] > 0 ? '提升' : '下降'}了 ${Math.abs(effects[key])}。`);
                        else if (key === 'defense') addLog(`统率${effects[key] > 0 ? '提升' : '下降'}了 ${Math.abs(effects[key])}。`);
                        else if (key === 'agility') addLog(`智力${effects[key] > 0 ? '提升' : '下降'}了 ${Math.abs(effects[key])}。`);
                        else if (key === 'charm') addLog(`政治${effects[key] > 0 ? '提升' : '下降'}了 ${Math.abs(effects[key])}。`);
                    }
                }
            }
            // 检查兵力是否为0，如果是则游戏结束
            if (gameState.health <= 0) {
                storyText.textContent = "兵败如山倒，你麾下将士所剩无几，霸业之路戛然而止。";
                choicesContainer.innerHTML = '';
                const restartBtn = document.createElement('button');
                restartBtn.className = 'choice-btn';
                restartBtn.textContent = '🔄 重新开始';
                restartBtn.onclick = resetGame;
                choicesContainer.appendChild(restartBtn);
                choicesContainer.style.gridTemplateColumns = '1fr';
                addLog("你的霸业已终结。");
                unlockAchievement('game_over'); // 可以添加一个“游戏结束”的成就
            }
        }


        // 处理玩家选择
        async function handleChoice(choice, choiceText) {
            showLoading('正在分析乱世局势...'); // 加载提示
            addLog(`选择了：${choiceText}`); // 添加到日志

            let prompt = "";
            let imagePrompt = ""; // 用于初始选择的特定图片提示

            // 处理初始选择
            if (gameState.currentScene === "start") {
                let initialStoryPrompt = "";
                switch (choice) {
                    case "humble_villager":
                        gameState.charName = "刘" + String.fromCharCode(0x4E00 + Math.floor(Math.random() * 20000)); // 随机化一个汉字作为名字
                        gameState.attack += 5; gameState.defense += 10; gameState.coins += 100; gameState.food += 500;
                        initialStoryPrompt = `你作为一名布衣平民，在乱世中艰难求生，但胸怀大志。你接下来会如何行动？提供一个关于你初入乱世的故事开端，并给出2-3个行动选项。`;
                        imagePrompt = "A humble villager in a war-torn Chinese village, ink wash painting style, Three Kingdoms era";
                        break;
                    case "exiled_noble":
                        gameState.charName = "袁" + String.fromCharCode(0x4E00 + Math.floor(Math.random() * 20000));
                        gameState.charm += 10; gameState.coins += 500; gameState.reputation += 20;
                        initialStoryPrompt = `你曾是显赫贵族之后，家族衰落后你流落民间，但仍有一定影响力。你接下来会如何行动？提供一个关于你如何在乱世中重振家族声威的故事开端，并给出2-3个行动选项。`;
                        imagePrompt = "An exiled Chinese noble in simple clothes, but with a dignified demeanor, Three Kingdoms era";
                        break;
                    case "loyal_retainer":
                        gameState.charName = "赵" + String.fromCharCode(0x4E00 + Math.floor(Math.random() * 20000));
                        gameState.attack += 15; gameState.defense += 5; gameState.health += 200; gameState.maxHealth += 200;
                        initialStoryPrompt = `你是一名忠义之士，渴望在乱世中寻觅明主，报效国家。你接下来会如何行动？提供一个关于你初次展现武勇，寻访明主的故事开端，并给出2-3个行动选项。`;
                        imagePrompt = "A loyal Chinese warrior, armed with a spear, standing firm amidst chaos, Three Kingdoms era";
                        break;
                    case "cunning_strategist":
                        gameState.charName = "诸葛" + String.fromCharCode(0x4E00 + Math.floor(Math.random() * 20000));
                        gameState.agility += 15; gameState.charm += 5; gameState.reputation += 10;
                        initialStoryPrompt = `你是一名隐居深山的谋士，洞察天下大势，等待时机。你接下来会如何行动？提供一个关于你如何出山辅佐明主，或独自施展智谋的故事开端，并给出2-3个行动选项。`;
                        imagePrompt = "A reclusive Chinese strategist in a bamboo forest, with a feather fan, Three Kingdoms era";
                        break;
                }
                prompt = `你现在是《三国志：乱世争雄》的AI游戏引擎，你的任务是根据玩家的选择，生成引人入胜、符合三国历史背景（或演义设定）的故事情节和合理的行动选项。请确保回复是有效的JSON格式。
                
                当前玩家角色是【${gameState.charName}】，出身为【${choiceText}】。
                你选择${choiceText}，${initialStoryPrompt} 
                
                请提供一个JSON对象，包含以下字段：
                - "story": 描述当前场景和故事进展的文字。
                - "choices": 一个包含2-4个行动选项的数组，每个选项应包含"text"（选项文本）和"target"（该选项的内部标识符）。
                - "imagePrompt" (可选): 用于生成当前场景图片（三国风格）的英文提示词。
                - "effects" (可选): 一个对象，包含对游戏状态的修改（如{"coins": 100, "attack": 5, "items": [{"name": "青囊书", "quantity": 1}], "achievements": ["recruit_general"]}）。可修改的属性包括：health, maxHealth, attack, defense, agility, charm, coins, food, reputation, level, skills, items, achievements。
                `;
                gameState.currentScene = choice; // 更新当前场景
                unlockAchievement('first_choice'); // 解锁成就
            } else {
                // 后续回合的AI提示词
                prompt = `你现在是《三国志：乱世争雄》的AI游戏引擎，你的任务是根据玩家的选择，生成引人入胜、符合三国历史背景（或演义设定）的故事情节和合理的行动选项。请确保回复是有效的JSON格式。
                
                当前玩家角色是【${gameState.charName}】，身份是【${getOfficialRank(gameState.level)}】。
                你拥有的属性：武力${gameState.attack}，统率${gameState.defense}，智力${gameState.agility}，政治${gameState.charm}。
                金钱：${gameState.coins}，粮草：${gameState.food}，兵力：${gameState.health}/${gameState.maxHealth}。
                声望：${gameState.reputation}。
                你目前的将领和策略有：${gameState.skills.map(s => s.name).join('，') || '无' }。
                你最近经历了：“${storyText.textContent.substring(0, Math.min(storyText.textContent.length, 200))}...”。
                你选择了“${choiceText}”。
                
                请根据这个选择和当前游戏状态，生成接下来的三国故事内容，并给出2-3个新的行动选项。着重强调三国时期的政治斗争、军事冲突、人物互动、内政发展、奇遇、招募将领、攻城略地等元素。
                
                请提供一个JSON对象，包含以下字段：
                - "story": 描述当前场景和故事进展的文字。
                - "choices": 一个包含2-4个行动选项的数组，每个选项应包含"text"（选项文本）和"target"（该选项的内部标识符）。
                - "imagePrompt" (可选): 用于生成当前场景图片（三国风格）的英文提示词。
                - "effects" (可选): 一个对象，包含对游戏状态的修改（如{"coins": 100, "attack": 5, "items": [{"name": "青囊书", "quantity": 1}], "achievements": ["recruit_general"]}）。可修改的属性包括：health, maxHealth, attack, defense, agility, charm, coins, food, reputation, level, skills, items, achievements。
                `;
            }

            try {
                const result = await promptLLM(prompt, "三国故事生成"); // 传递一个描述性的任务名
                if (result && result.story) {
                    storyText.textContent = result.story;
                    updateChoices(result.choices);

                    // 优先使用AI生成的imagePrompt，否则使用初始选择的imagePrompt
                    if (result.imagePrompt) {
                        await generateImage(result.imagePrompt, "三国场景图片");
                    } else if (imagePrompt) { // 如果初始选择有特定图片提示
                        await generateImage(imagePrompt, "三国人物图片");
                    } else {
                        // 如果AI没有提供，且没有初始图片提示，可以尝试根据故事内容生成一个通用图片提示
                        await generateImage("An atmospheric scene from the Three Kingdoms era, illustrating the story: " + result.story.substring(0, Math.min(result.story.length, 50)), "三国场景图片");
                    }

                    // 应用效果
                    if (result.effects) {
                        applyEffects(result.effects);
                    }
                    addLog(result.story); // 将新故事添加到日志
                    gameState.turn++; // 增加回合数
                    updateUI();
                } else {
                    console.error("AI生成结果无效:", result);
                    storyText.textContent = "似乎发生了时空错乱，请重新选择或重置游戏。";
                    updateChoices([{ text: "重置游戏", target: "reset" }]);
                }
            } catch (error) {
                console.error("处理选择时发生错误:", error);
                storyText.textContent = "乱世迷雾笼罩，无法看清前路。请检查API设置或重试。";
                updateChoices([{ text: "重置游戏", target: "reset" }]);
            } finally {
                hideLoading();
            }
        }

        // 重置游戏
        async function resetGame() {
            if (confirm('确定要重置游戏吗？这将清除所有进度，无法恢复！')) {
                localStorage.removeItem('sanguoGameSave'); // 更改保存名称
                // 重置游戏状态到初始值
                gameState = {
                    charName: "无名主公",
                    faction: null,
                    health: 1000,
                    maxHealth: 1000,
                    attack: 60,
                    defense: 60,
                    agility: 60,
                    charm: 60,
                    coins: 500,
                    food: 1000,
                    reputation: 0,
                    level: 1,
                    skills: [
                        { name: "基础步法", description: "简单的步兵操练，提高部队纪律性", icon: "fa-solid fa-person-military-rifle" },
                        { name: "市井情报", description: "通过市井传闻获取基本信息", icon: "fa-solid fa-magnifying-glass" }
                    ],
                    items: [],
                    achievements: gameState.achievements.map(ach => ({ ...ach, unlocked: false })), // 重置所有成就为未解锁
                    adventureLog: [],
                    turn: 0,
                    currentScene: "start"
                };

                // 重置界面到初始状态
                storyText.textContent = '你从一场混沌的梦境中醒来，耳边是刀剑碰撞的喧嚣与百姓的哀嚎。你意识到，你并非身处于太平盛世，而是来到了一个战火纷飞的年代——东汉末年，群雄并起的三国乱世。在这里，天下分崩离析，民不聊生，而你，将如何在这乱世中立足，成就一番霸业？一个声音在你心中回荡：“此乃天命所归，亦是汝之抉择。选择你的出身，开启你的乱世征途吧。”';
                choicesContainer.innerHTML = `
                    <button class="choice-btn" data-choice="humble_villager">🏡 布衣出身，胸怀天下</button>
                    <button class="choice-btn" data-choice="exiled_noble">👑 落魄贵族，旧日余晖</button>
                    <button class="choice-btn" data-choice="loyal_retainer">⚔️ 忠义之士，为国效力</button>
                    <button class="choice-btn" data-choice="cunning_strategist">💡 隐居谋士，智定乾坤</button>
                `;
                // 重置场景图片为三国主题的初始图片
                const initialImagePrompt = "A panoramic view of ancient China during the Three Kingdoms period, with distant mountains, a river, and smoke rising from a battlefield, in a traditional Chinese ink painting style.";
                try {
                    await generateImage(initialImagePrompt, "三国乱世初始场景"); // 增加任务描述
                } catch (error) {
                    console.error("重置时图片加载失败:", error);
                }
                updateUI();
                alert('游戏已重置！');
                addLog("游戏已重置，新的征程开始！");
            }
        }

        // 页面加载完成时执行
        document.addEventListener('DOMContentLoaded', () => {
            loadGameState();
            // 为初始按钮添加事件监听器
            choicesContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('choice-btn')) {
                    const choice = event.target.dataset.choice;
                    const choiceText = event.target.textContent;
                    // 确保只有在当前场景是"start"时才允许初始选择
                    if (gameState.currentScene === "start" || choice === "reset") { // 允许重置
                        handleChoice(choice, choiceText);
                    }
                }
            });
        });
    </script>
</body>
</html>
