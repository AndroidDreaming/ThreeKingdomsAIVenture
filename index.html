<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9067024774549867"
      crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="《三国模拟人生》是一个由AI驱动的文字策略沙盒游戏。在这里，你可以体验从一介布衣到称霸天下的完整三国征程，探索广袤的中华大地，做出你的选择，书写你的传奇。">
    <meta name="keywords" content="三国, 文字游戏, 策略, MUD, AI, 沙盒, 乱世, 角色扮演, RPG, 互动演义">
    <meta name="author" content="AI沙盒世界">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ai-game.jkai.de/">
    <meta property="og:title" content="三国模拟人生 - AI驱动的沙盒策略演义">
    <meta property="og:description" content="置身三国乱世，从籍籍无名到一统天下，你的每一步谋略都将铸就独一无二的霸业。">
    <meta property="og:image" content="https://ai-game.jkai.de/preview-image.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://ai-game.jkai.de/">
    <meta property="twitter:title" content="三国模拟人生 - AI驱动的沙盒策略演义">
    <meta property="twitter:description" content="置身三国乱世，从籍籍无名到一统天下，你的每一步谋略都将铸就独一无二的霸业。">
    <meta property="twitter:image" content="https://ai-game.jkai.de/preview-image.jpg">
    <title>三国模拟人生 - AI沙盒世界</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5A8D9F; /* Soft blue-grey */
            --accent-color: #D6A47C; /* Muted orange-brown */
            --secondary-accent-color: #A3CC91; /* Soft green */
            --bg-dark: #1E2733; /* Darker background */
            --bg-light: #2A3642; /* Lighter background for elements */
            --text-light: #E0E6EB; /* Light text */
            --border-subtle: rgba(90, 141, 159, 0.4); /* Subtler border color */
            --border-strong: var(--primary-color); /* Stronger border for emphasis */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans SC', 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            padding: 15px; /* Slightly reduced overall padding */
            background-image:
                radial-gradient(circle at 15% 25%, rgba(90, 141, 159, 0.08) 0%, transparent 20%),
                radial-gradient(circle at 85% 75%, rgba(214, 164, 124, 0.08) 0%, transparent 20%);
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        .container {
            max-width: 960px; /* Slightly narrower max-width */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 95vh;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            border-radius: 10px; /* Slightly less rounded */
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 25px 15px; /* Reduced padding */
            margin-bottom: 15px; /* Reduced margin */
            position: relative;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border-subtle);
            border-radius: 10px 10px 0 0;
        }
        
        h1 {
            font-size: 2.2rem; /* Slightly smaller font size */
            margin-bottom: 8px;
            color: var(--primary-color);
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1rem; /* Slightly smaller font size */
            color: var(--accent-color);
            opacity: 0.8;
        }
        
        .game-ui {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px; /* Reduced gap */
            flex: 1;
            padding: 15px; /* Reduced padding */
            background: var(--bg-dark);
        }
        
        .game-area {
            background: var(--bg-light);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 20px; /* Reduced padding */
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .scene-container {
            position: relative;
            min-height: 250px; /* Reduced min-height */
            margin-bottom: 20px; /* Reduced margin */
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 7px rgba(0, 0, 0, 0.3);
        }
        
        #scene-img {
            max-width: 100%;
            max-height: 230px; /* Reduced max-height */
            border-radius: 4px;
            object-fit: contain;
            image-rendering: auto;
        }
        
        .story-text {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 18px; /* Reduced padding */
            margin-bottom: 20px; /* Reduced margin */
            font-size: 1rem; /* Slightly smaller font size */
            line-height: 1.7;
            min-height: 130px; /* Reduced min-height */
            box-shadow: inset 0 0 7px rgba(0, 0, 0, 0.4);
            overflow-y: auto;
        }
        
        .choices-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px; /* Reduced gap */
        }
        
        .choice-btn {
            background: var(--bg-dark);
            border: 1px solid var(--primary-color);
            color: var(--text-light);
            padding: 12px 18px; /* Reduced padding */
            border-radius: 6px;
            font-size: 0.9rem; /* Slightly smaller font size */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: left;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        .choice-btn:hover {
            background: var(--primary-color);
            color: var(--bg-dark);
            transform: translateY(-1px); /* More subtle lift */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        }
        
        .choice-btn:active {
            transform: translateY(0);
            background: color-mix(in srgb, var(--primary-color) 80%, black);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .choice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transition: 0.5s ease-out;
        }
        
        .choice-btn:hover::before {
            left: 100%;
        }
        
        .custom-choice-container {
            margin-top: 20px; /* Adjusted margin for custom input area */
            display: flex;
            flex-direction: column;
            gap: 10px; /* Adjusted gap for custom input elements */
            padding-top: 15px; /* Added padding to separate from choices */
            border-top: 1px dashed var(--border-subtle);
        }

        .custom-choice-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 8px; /* Adjusted gap */
        }

        .custom-input-box {
            display: flex;
            gap: 8px; /* Gap between input and button */
        }

        #custom-choice-input {
            flex-grow: 1;
            padding: 10px 12px; /* Adjusted padding */
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            background: var(--bg-dark);
            color: var(--text-light);
            font-size: 0.9rem; /* Adjusted font size */
            outline: none;
            transition: border-color 0.2s ease;
        }

        #custom-choice-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(214, 164, 124, 0.3);
        }

        #submit-custom-choice {
            background: var(--accent-color);
            color: var(--bg-dark);
            border: none;
            padding: 10px 18px; /* Adjusted padding */
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem; /* Adjusted font size */
            transition: background 0.2s ease, transform 0.1s ease;
            white-space: nowrap; /* Prevent button text from wrapping */
        }

        #submit-custom-choice:hover {
            background: color-mix(in srgb, var(--accent-color) 85%, black);
            transform: translateY(-1px);
        }

        #submit-custom-choice:active {
            transform: translateY(0);
            background: color-mix(in srgb, var(--accent-color) 70%, black);
        }
        
        .skill-btn {
            display: flex;
            align-items: center;
            gap: 8px; /* Reduced gap */
            margin-top: 6px; /* Reduced margin */
        }
        
        .stats-panel {
            background: var(--bg-light);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 20px; /* Reduced padding */
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px; /* Reduced gap */
        }
        
        .panel-title {
            font-size: 1.2rem; /* Slightly smaller font size */
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 8px; /* Reduced margin */
            border-bottom: 1px dashed var(--border-subtle);
            padding-bottom: 8px; /* Reduced padding */
            font-weight: 500;
        }
        
        .character-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 15px; /* Reduced padding */
            border: 1px solid var(--primary-color);
        }
        
        .char-header {
            display: flex;
            align-items: center;
            gap: 12px; /* Reduced gap */
            margin-bottom: 12px; /* Reduced margin */
        }
        
        .char-icon {
            width: 50px; /* Slightly smaller */
            height: 50px; /* Slightly smaller */
            border-radius: 50%;
            background: var(--primary-color);
            color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem; /* Adjusted font size */
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .char-name {
            font-size: 1.2rem; /* Slightly smaller font size */
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .health-bar {
            height: 16px; /* Reduced height */
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px; /* Adjusted border-radius */
            margin: 8px 0; /* Reduced margin */
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-accent-color), var(--accent-color));
            border-radius: 8px;
            transition: width 0.4s ease-out;
        }
        
        .health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem; /* Slightly smaller font size */
            color: var(--text-light);
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px; /* Reduced gap */
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 10px; /* Reduced padding */
            border-radius: 5px; /* Slightly less rounded */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-value {
            font-size: 1.2rem; /* Slightly smaller font size */
            color: var(--accent-color);
            font-weight: 600;
            display: block;
            margin-top: 3px; /* Reduced margin */
        }
        
        .skills-container, .inventory-container, .achievement-container, .adventure-log-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 15px; /* Reduced padding */
            margin-bottom: 5px;
        }

        .skills-container { border: 1px solid var(--secondary-accent-color); }
        .inventory-container { border: 1px solid var(--accent-color); }
        .achievement-container { border: 1px solid gold; }
        .adventure-log-container { border: 1px solid var(--primary-color); }

        .scrollable-content {
            max-height: 120px; /* Further reduced height */
            overflow-y: auto;
            padding-right: 6px; /* For scrollbar */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) rgba(0, 0, 0, 0.1);
        }

        .scrollable-content::-webkit-scrollbar {
            width: 6px; /* Thinner scrollbar */
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
            border: 2px solid var(--bg-light);
        }
        
        .skill-list {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Reduced gap */
        }
        
        .skill-item {
            background: rgba(90, 141, 159, 0.1);
            padding: 8px; /* Reduced padding */
            border-radius: 4px; /* Slightly less rounded */
            border-left: 3px solid var(--secondary-accent-color);
        }
        
        .skill-name {
            color: var(--secondary-accent-color);
            margin-bottom: 1px; /* Reduced margin */
            display: flex;
            align-items: center;
            gap: 6px; /* Reduced gap */
            font-weight: 600;
            font-size: 0.9rem; /* Slightly smaller font size */
        }
        
        .skill-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem; /* Slightly smaller font size */
            line-height: 1.4;
        }
        
        .items-grid {
            display: block;
            margin-top: 8px; /* Reduced margin */
        }

        .item-text, .achievement-text {
            padding: 3px 0; /* Reduced padding */
            text-align: left;
            width: 100%;
            font-size: 0.85rem; /* Slightly smaller font size */
            color: rgba(255, 255, 255, 0.8);
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px; /* Reduced margin */
            padding: 12px; /* Reduced padding */
            background: var(--bg-light);
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.85rem; /* Slightly smaller font size */
            color: rgba(255, 255, 255, 0.7);
        }
        
        .status-value {
            font-size: 1.2rem; /* Slightly smaller font size */
            color: var(--accent-color);
            font-weight: 600;
            margin-top: 4px; /* Reduced margin */
        }

        .game-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0; /* Add margin above and below */
            padding: 10px;
            background: var(--bg-light);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
            gap: 15px; /* Added gap for potential multiple buttons */
        }

        .control-btn {
            background: var(--primary-color);
            color: var(--bg-dark);
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease, transform 0.1s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .control-btn:hover {
            background: color-mix(in srgb, var(--primary-color) 85%, black);
            transform: translateY(-1px);
        }

        .control-btn:active {
            transform: translateY(0);
            background: color-mix(in srgb, var(--primary-color) 70%, black);
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 13, 26, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            border-radius: 8px;
        }
        
        .loading.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .loading-spinner {
            width: 40px; /* Slightly smaller */
            height: 40px; /* Slightly smaller */
            border: 4px solid rgba(90, 141, 159, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px; /* Reduced margin */
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1rem; /* Slightly smaller font size */
            color: var(--primary-color);
            text-align: center;
        }
        
        footer {
            text-align: center;
            padding: 15px; /* Reduced padding */
            margin-top: 15px; /* Reduced margin */
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem; /* Slightly smaller font size */
            border-top: 1px dashed var(--border-subtle);
            background: var(--bg-light);
            border-radius: 0 0 10px 10px;
        }
        
        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Even less padding on smallest screens */
            }

            .container {
                border-radius: 0; /* No border-radius on mobile for full width */
                box-shadow: none; /* No box-shadow on mobile */
            }

            header {
                padding: 20px 10px; /* More compact header */
                margin-bottom: 10px;
                border-radius: 0;
            }

            h1 {
                font-size: 1.8rem; /* Smaller title on mobile */
            }
            .subtitle {
                font-size: 0.9rem; /* Smaller subtitle on mobile */
            }

            .game-ui { 
                grid-template-columns: 1fr; 
                padding: 10px; /* More compact overall game UI padding */
                gap: 15px; /* Reduced gap */
            }
            
            .game-area {
                padding: 15px; /* More compact game area padding */
            }

            .scene-container {
                min-height: 200px; /* Further reduced min-height for scene */
                margin-bottom: 15px;
            }

            #scene-img {
                max-height: 180px; /* Adjusted image max-height */
            }

            .story-text {
                padding: 15px; /* More compact story text padding */
                margin-bottom: 15px;
                font-size: 0.95rem; /* Adjusted font size */
                min-height: 100px; /* Adjusted min-height */
            }

            .choices-container { 
                grid-template-columns: 1fr; /* Stack choices vertically */
                gap: 10px; /* Reduced gap */
            }
            
            .choice-btn {
                padding: 12px 15px; /* Adjusted padding */
                font-size: 0.85rem; /* Adjusted font size */
            }

            .custom-choice-container {
                margin-top: 15px; /* Reduced margin on mobile */
                gap: 8px; /* Reduced gap on mobile */
                padding-top: 10px; /* Reduced padding on mobile */
            }
            #custom-choice-input {
                padding: 10px; /* Adjusted padding */
                font-size: 0.85rem; /* Adjusted font size */
                height: auto; /* Allow height to adjust */
            }
            #submit-custom-choice {
                padding: 0 15px; /* Adjusted padding */
                font-size: 0.85rem; /* Adjusted font size */
            }
            .custom-choice-label {
                font-size: 0.8rem; /* Adjusted font size */
                gap: 6px;
            }
            
            .stats-panel {
                padding: 15px; /* More compact stats panel padding */
                gap: 15px; /* Maintained for clarity between sections */
            }

            .panel-title {
                font-size: 1.1rem; /* Smaller panel title */
                margin-bottom: 10px;
            }

            .character-info {
                padding: 12px; /* More compact char info */
            }

            .char-icon {
                width: 45px; /* Even smaller icon */
                height: 45px;
                font-size: 1.4rem;
            }

            .char-name {
                font-size: 1.1rem; /* Smaller char name */
            }

            .health-bar {
                height: 14px; /* Even smaller health bar */
                margin: 6px 0;
            }

            .health-text {
                font-size: 0.65rem; /* Smaller health text */
            }

            .stats-grid {
                gap: 8px; /* Reduced gap */
            }

            .stat-item {
                padding: 8px; /* Reduced padding */
                font-size: 0.8rem; /* Reduced label font size */
            }
            .stat-value {
                font-size: 1.1rem; /* Reduced stat value font size */
            }

            .skills-container, .inventory-container, .achievement-container, .adventure-log-container {
                padding: 12px; /* More compact section padding */
            }

            .scrollable-content {
                max-height: 90px; /* Significantly reduced height on mobile */
                padding-right: 4px; /* Thinner padding for scrollbar */
            }
            .scrollable-content::-webkit-scrollbar {
                width: 4px; /* Even thinner scrollbar */
            }

            .skill-item {
                padding: 6px; /* Reduced padding */
            }
            .skill-name {
                font-size: 0.85rem; /* Adjusted font size */
            }
            .skill-description {
                font-size: 0.7rem; /* Adjusted font size */
            }
            .item-text, .achievement-text {
                font-size: 0.8rem; /* Adjusted font size */
            }

            .status-bar {
                flex-wrap: wrap;
                gap: 10px; /* Reduced gap */
                padding: 10px; /* Reduced padding */
            }
            .status-item {
                font-size: 0.8rem; /* Reduced font size */
            }
            .status-value {
                font-size: 1.1rem; /* Reduced font size */
            }
            
            .game-controls {
                flex-direction: column; /* Stack buttons vertically on mobile */
                gap: 10px;
                margin: 15px 0;
                padding: 10px;
            }
            
            .control-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .api-settings-container {
                padding: 20px;
                margin-top: 20px;
            }
            .api-settings {
                grid-template-columns: 1fr; /* Stack elements on small screens */
            }
            .api-settings input, .api-settings-select, .api-settings button {
                width: 100%; /* Full width for input elements and buttons */
            }
            .api-settings-select {
                margin-bottom: 5px; /* Add slight margin below select on mobile */
            }

            footer {
                padding: 12px; /* Reduced padding */
                font-size: 0.75rem; /* Smaller footer font */
                margin-top: 10px;
                border-radius: 0;
            }
        }

        /* --- PC-specific adjustments (for screens wider than 768px) --- */
        @media (min-width: 769px) {
            #custom-choice-input {
                font-size: 1rem; /* Larger font for PC */
                padding: 12px 15px; /* More comfortable padding for PC */
            }
            #submit-custom-choice {
                font-size: 1rem; /* Larger font for PC button */
                padding: 12px 20px; /* More comfortable padding for PC button */
            }
            .custom-choice-label {
                font-size: 0.95rem; /* Slightly larger label */
            }
            .choices-container {
                gap: 15px; /* Slightly more space between choice buttons on PC */
            }
            .choice-btn {
                padding: 14px 20px; /* More comfortable padding for PC choice buttons */
                font-size: 0.95rem; /* Slightly larger font for PC choice buttons */
            }
            .story-text {
                font-size: 1.05rem; /* Slightly larger story text for PC */
                min-height: 150px; /* More generous height for PC story text */
            }
            .scene-container {
                min-height: 280px; /* More generous height for scene on PC */
                margin-bottom: 25px; /* Slightly more margin below scene on PC */
            }
            #scene-img {
                max-height: 260px; /* More generous image height on PC */
            }
            .stats-panel {
                gap: 20px; /* More space between sections in stats panel on PC */
            }
            .scrollable-content {
                max-height: 150px; /* More height for scrollable content on PC */
            }
            .panel-title {
                font-size: 1.3rem; /* Slightly larger panel title on PC */
            }
            .char-name {
                font-size: 1.3rem; /* Slightly larger char name on PC */
            }
            .stat-value {
                font-size: 1.3rem; /* Slightly larger stat values on PC */
            }
            /* 重开按钮PC端调整 */
            .control-btn {
                padding: 12px 25px; /* Increased padding for a larger button */
                font-size: 1rem; /* Larger font size */
                gap: 10px; /* Slightly more space for icon and text */
            }
            .game-controls {
                margin: 20px 0; /* More vertical space on PC */
                padding: 12px; /* Slightly more padding for the container */
            }
        }
    </style>
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DFX8DXLG3F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DFX8DXLG3F');
</script>
<body>
<div class="container">
    <header>
        <h1>三国模拟人生</h1>
        <p class="subtitle">大模型文字大冒险</p>
    </header>

    <div class="status-bar">
        <div class="status-item"><span>铜钱</span><span class="status-value">50</span></div>
        <div class="status-item"><span>声望</span><span class="status-value">0</span></div>
        <div class="status-item"><span>身份</span><span class="status-value">布衣</span></div>
    </div>

    <div class="game-controls">
        <button id="reset-game-btn" class="control-btn reset-btn">🔄 重开局势</button>
    </div>

    <div class="game-ui">
        <div class="game-area">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">正在推演新的乱世...</div>
            </div>
            
            <div class="image-settings-container">
                <h3 class="panel-title">场景图片设置</h3>
                <div class="image-settings">
                    <label for="toggle-image-rendering">
                        <input type="checkbox" id="toggle-image-rendering">
                        <span>渲染场景图片</span>
                    </label>
                </div>
                <p id="image-warning-message" class="image-warning" style="display: none;">
                    勾选此项可能会增加图片加载时间，影响游戏速度。
                </p>
            </div>

            <div class="scene-container">
                <img id="scene-img" src="" alt="场景图片">
            </div>
            <div class="story-text" id="story-text">
                你从一个悠长的梦境中惊醒，是闻所未闻的喧嚣与繁华。但眼前，却是简陋的茅屋、微弱的油灯。窗外，战火渐近，狼烟四起，远方山峦在暮色中影影绰绰。你意识到，你来到了一个名为"汉末三国"的乱世。在这里，无论是布衣百姓还是豪杰名士，皆可凭借智谋与武勇，逐鹿中原，问鼎天下，开创属于自己的盛世。一个神秘的声音在你脑海中回响："此乃天命所归，亦是汝之抉择。选择你的出身，书写你的传奇吧。"
            </div>
            <div class="choices-container" id="choices-container">
                <button class="choice-btn" data-choice="汉室宗亲">📜 汉室宗亲，身世浮沉</button>
                <button class="choice-btn" data-choice="地方豪强">🌾 地方豪强，力耕天下</button>
                <button class="choice-btn" data-choice="落魄士人">📚 落魄士人，满腹经纶</button>
                <button class="choice-btn" data-choice="行商之子">💰 行商之子，财运亨通</button>
                <button class="choice-btn" data-choice="战乱流民">⚔️ 战乱流民，乱世求生</button>
            </div>
            
            <div class="custom-choice-container">
                <div class="custom-choice-label">
                    <i class="fas fa-pen"></i> 或自行决定行动：
                </div>
                <div class="custom-input-box">
                    <input type="text" id="custom-choice-input" placeholder="输入你的行动（如：拜访贤士、招募兵卒、侦察敌情...）">
                    <button id="submit-custom-choice">提交</button>
                </div>
            </div>
        </div>
        <div class="stats-panel">
            <h2 class="panel-title">角色状态</h2>
            <div class="character-info">
                <div class="char-header">
                    <div class="char-icon">👤</div>
                    <div id="char-name" class="char-name">无名小卒</div>
                </div>
                <div class="health-bar">
                    <div id="health-bar" class="health-fill"></div>
                    <div id="health-text" class="health-text">体力: 100/100</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><span>武力</span><span id="attack-value" class="stat-value">5</span></div>
                    <div class="stat-item"><span>智力</span><span id="defense-value" class="stat-value">5</span></div>
                    <div class="stat-item"><span>统率</span><span id="agility-value" class="stat-value">5</span></div>
                    <div class="stat-item"><span>魅力</span><span id="charm-value" class="stat-value">5</span></div>
                </div>
            </div>
            <div class="skills-container">
                <h3 class="panel-title">战法/计策</h3>
                <div id="skills-list" class="scrollable-content"></div>
            </div>
            <div class="inventory-container">
                <h3 class="panel-title">行囊</h3>
                <div id="items-grid" class="scrollable-content"></div>
            </div>
            <div class="achievement-container">
                <h3 class="panel-title">功绩</h3>
                <div id="achievement-list" class="scrollable-content"></div>
            </div>
            <div class="adventure-log-container">
                <h3 class="panel-title">大事记</h3>
                <div id="adventure-log" class="scrollable-content"></div>
            </div>
        </div>
    </div>

    <div class="api-settings-container">
        <h3 class="panel-title">AI模型设置</h3>
        <p id="api-settings-hint" style="font-size: 0.9rem; color: #888; margin-bottom: 15px;">
            🔒 默认使用安全的后端API，无需配置。<br>
            如需使用自定义API，请填写以下信息（配置仅存于前端浏览器，无需担心泄露）：
        </p>
        <div class="api-settings">
            <input type="text" id="api-url-input" placeholder="自定义API URL (可选)">
            <select id="model-input" class="api-settings-select"></select>
            <input type="password" id="api-key-input" placeholder="自定义API Key (可选)">
            <button id="save-api-btn">保存</button>
            <button id="clear-api-btn">清除</button>
        </div>
    </div>

    <footer>
        享受你的游戏
    </footer>
</div>

    <script>
	
        // 游戏状态
        const gameState = {
			identity: '布衣',
            faction: null,
            health: 100,
            maxHealth: 100,
            attack: 5,
            defense: 5,
            agility: 5,
            charm: 5,
            coins: 50,
            reputation: 0,
            level: 1, 
            skills: [
                {
                    name: "基础拳法",
                    description: "基本武学招式，近身战斗时发挥作用",
                    icon: "fa-solid fa-hand-fist"
                },
                {
                    name: "凝神静气",
                    description: "冷静心思",
                    icon: "fa-solid fa-wind"
                }
            ],
            items: [],
            achievements: [
                // 基础功绩
                { id: 'first_choice', text: '初入乱世: 做出你的人生抉择', unlocked: false },
                { id: 'first_battle', text: '初试刀兵: 第一次亲临沙场', unlocked: false },
                { id: 'first_victory', text: '首战告捷: 赢得第一场小规模胜利', unlocked: false },
                { id: 'breakthrough_qi', text: '崭露头角: 在郡县乡里获得一定名声', unlocked: false },
                { id: 'breakthrough_foundation', text: '一方豪强: 成功占领一县之地或聚拢一批追随者', unlocked: false },

                // 探索与机遇
                { id: 'found_hidden_cave', text: '奇遇迭出: 发现一处隐秘的洞窟，内藏珍稀宝物', unlocked: false }, 
                { id: 'found_ancient_ruin', text: '寻访古迹: 深入人迹罕至之地，发现一处荒废的古战场或前朝遗址', unlocked: false },
                { id: 'met_mysterious_master', text: '三顾茅庐: 发现并成功招募到一位隐世不出的贤才', unlocked: false }, 
                { id: 'survive_miasma_swamp', text: '化险为夷: 成功穿越危机四伏的山岭或沼泽地带', unlocked: false },

                // 财富与资历
                { id: 'first_spirit_treasure', text: '得遇良驹: 获得一匹千里马或一件稀世兵器', unlocked: false },
                { id: 'rich_man', text: '富可敌国: 聚拢大量钱粮，足以支撑一支军队', unlocked: false },
                { id: 'master_alchemist', text: '军需官: 精通军备生产或伤药制作', unlocked: false },
                { id: 'spirit_stone_collector', text: '屯田能手: 成功开发三处不同类型的富饶土地', unlocked: false },

                // 战斗与策略
                { id: 'flawless_victory', text: '兵不血刃: 在不损一兵一卒的情况下赢得一场胜利', unlocked: false },
                { id: 'slay_demon_beast', text: '阵斩敌将: 在万军之中斩杀敌方主将', unlocked: false },
                { id: 'master_of_spells', text: '运筹帷幄: 成功策划并实施一项扭转战局的计谋', unlocked: false },
                { id: 'survived_ambush', text: '突出重围: 在敌军的重重包围中全身而退', unlocked: false },
                { id: 'first_skill', text: '学有所成: 掌握一项实用的武艺或治国方略', unlocked: false },
                { id: 'skill_master', text: '百艺精通: 掌握五种不同的军政或民生技能', unlocked: false },
                { id: 'sword_master', text: '万人敌: 个人武艺达到超凡入圣的境界', unlocked: false },
                { id: 'spell_caster', text: '兵法大家: 精通《孙子兵法》等兵书，能布下精妙阵型', unlocked: false },

                // 社交与声望
                { id: 'high_reputation', text: '威震一方: 在郡县乃至州域内建立崇高威望', unlocked: false },
                { id: 'sect_elder', text: '拜将入相: 受到一方诸侯重用，身居高位', unlocked: false },
                { id: 'dao_companion', text: '喜结良缘: 与一位世家女子或贤良淑女结为连理', unlocked: false },
                { id: 'peacemaker', text: '以德服人: 成功调解两大世家或地方势力间的纷争', unlocked: false },

                // 特殊与隐藏
                { id: 'defy_heavenly_tribulation', text: '力挽狂澜: 在大厦将倾之际，力保社稷不失', unlocked: false },
                { id: 'ancient_bloodline', text: '昭烈遗志: 继承或光复了衰落的汉室血脉', unlocked: false },
                { id: 'uncovered_conspiracy', text: '拨乱反正: 发现并瓦解了一个颠覆朝纲的巨大阴谋', unlocked: false }
            ],
            adventureLog: [],
            turn: 0,
            currentScene: "start"
        };

        // DOM元素
        const storyText = document.getElementById('story-text');
        const choicesContainer = document.getElementById('choices-container');
        const sceneImg = document.getElementById('scene-img');
        const loadingOverlay = document.getElementById('loading');
        const charName = document.getElementById('char-name');
        const healthBar = document.getElementById('health-bar');
        const healthText = document.getElementById('health-text');
        const skillsList = document.getElementById('skills-list');
        const apiUrlInput = document.getElementById('api-url-input');
        const modelInput = document.getElementById('model-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiBtn = document.getElementById('save-api-btn');
        const clearApiBtn = document.getElementById('clear-api-btn');
        const coinsEl = document.querySelector('.status-bar .status-item:nth-child(1) .status-value');
        const reputationEl = document.querySelector('.status-bar .status-item:nth-child(2) .status-value');
        const levelEl = document.querySelector('.status-bar .status-item:nth-child(3) .status-value');
        const attackEl = document.getElementById('attack-value');
        const defenseEl = document.getElementById('defense-value');
        const agilityEl = document.getElementById('agility-value');
        const charmEl = document.getElementById('charm-value');
        const itemsGrid = document.getElementById('items-grid');
        const achievementList = document.getElementById('achievement-list');
        const adventureLogEl = document.getElementById('adventure-log');
        const customChoiceInput = document.getElementById('custom-choice-input');
        const submitCustomChoiceBtn = document.getElementById('submit-custom-choice');
		
		let enableImageRendering = false;

		const toggleImageRenderingCheckbox = document.getElementById('toggle-image-rendering');
		toggleImageRenderingCheckbox.addEventListener('change', () => {
			enableImageRendering = toggleImageRenderingCheckbox.checked;
			const warningMessage = document.getElementById('image-warning-message');
			warningMessage.style.display = enableImageRendering ? 'block' : 'none';
		});


        // 保存游戏状态
        function saveGameState() {
            try {
                // 保存当前的选择按钮
                const currentChoices = [];
                const choiceButtons = choicesContainer.querySelectorAll('.choice-btn');
                choiceButtons.forEach(btn => {
                    currentChoices.push({
                        text: btn.textContent,
                        target: btn.dataset.choice
                    });
                });

                const saveData = {
                    gameState: gameState,
                    currentStoryText: storyText.textContent,
                    currentSceneImg: sceneImg.src,
                    currentChoices: currentChoices,
                    saveTime: new Date().toISOString()
                };
                localStorage.setItem('cultivationGameSave', JSON.stringify(saveData));
                console.log('游戏状态已保存');
                return true;
            } catch (error) {
                console.error('保存游戏状态失败:', error);
                return false;
            }
        }

        // 加载游戏状态
        function loadGameState() {
            try {
                const saveData = localStorage.getItem('cultivationGameSave');
                if (!saveData) return false;
                
                const parsed = JSON.parse(saveData);
                if (!parsed.gameState) return false;
                
                // 恢复游戏状态
                Object.assign(gameState, parsed.gameState);

                // 在加载时检查游戏是否结束
                if (gameState.health <= 0) {
                    updateUI();
                    storyText.textContent = "你倒在血泊之中，意识逐渐模糊... 你的冒险已在此终结。";
                    choicesContainer.innerHTML = '';
                    const restartBtn = document.createElement('button');
                    restartBtn.className = 'choice-btn';
                    restartBtn.textContent = '🔄 重新开始';
                    restartBtn.onclick = resetGame;
                    choicesContainer.appendChild(restartBtn);
                    choicesContainer.style.gridTemplateColumns = '1fr';
                    console.log('加载到游戏结束状态');
                    return true;
                }
                
                // 恢复界面
                if (parsed.currentStoryText) {
                    storyText.textContent = parsed.currentStoryText;
                }
                if (parsed.currentSceneImg && parsed.currentSceneImg !== window.location.href && !parsed.currentSceneImg.includes('undefined')) {
                    sceneImg.src = parsed.currentSceneImg;
                    sceneImg.style.opacity = 1;
                }
                
                // 恢复选择按钮
                if (parsed.currentChoices && Array.isArray(parsed.currentChoices)) {
                    choicesContainer.innerHTML = '';
                    parsed.currentChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.dataset.choice = choice.target;
                        button.textContent = choice.text;
                        choicesContainer.appendChild(button);
                    });
                }
                
                updateUI();
                console.log('游戏状态已加载，保存时间:', parsed.saveTime);
                return true;
            } catch (error) {
                console.error('加载游戏状态失败:', error);
                return false;
            }
        }

        // 重置游戏
        async function resetGame() {
            if (confirm('确定要重开一局吗？这将清除所有进度，无法恢复，天下大势将重新推演！')) {
                // 清除保存的游戏状态
                localStorage.removeItem('cultivationGameSave');

                // 重置游戏状态到初始值
                gameState.faction = null;
                gameState.health = 100;
                gameState.maxHealth = 100;
                gameState.attack = 5;
                gameState.defense = 5;
                gameState.agility = 5;
                gameState.charm = 5;
                gameState.coins = 50;
                gameState.reputation = 0;
                gameState.level = 1;
                gameState.skills = [
                    {
                        name: "基础拳法",
                        description: "基本武学招式，近身战斗时发挥作用",
                        icon: "fa-solid fa-hand-fist"
                    },
                    {
                        name: "凝神静气",
                        description: "冷静心思",
                        icon: "fa-solid fa-wind"
                    }
                ];
                gameState.items = [];
                gameState.achievements.forEach(ach => ach.unlocked = false);
                gameState.adventureLog = [];
                gameState.turn = 0;
                gameState.currentScene = "start";

                // 重置界面到初始状态
                storyText.textContent = '你从一个悠长的梦境中惊醒，梦里是未来世界的奇巧淫技，是闻所未闻的喧嚣与繁华。但眼前，却是简陋的茅屋、微弱的油灯。窗外，战火渐近，狼烟四起，远方山峦在暮色中影影绰绰。你意识到，你来到了一个名为"汉末三国"的乱世。在这里，无论是布衣百姓还是豪杰名士，皆可凭借智谋与武勇，逐鹿中原，问鼎天下，开创属于自己的盛世。一个神秘的声音在你脑海中回响："此乃天命所归，亦是汝之抉择。选择你的出身，书写你的传奇吧。"';

                // 重置选择按钮
                choicesContainer.innerHTML = `
                    <button class="choice-btn" data-choice="汉室宗亲">📜 汉室宗亲，身世浮沉</button>
                    <button class="choice-btn" data-choice="地方豪强">🌾 地方豪强，力耕天下</button>
                    <button class="choice-btn" data-choice="落魄士人">📚 落魄士人，满腹经纶</button>
                    <button class="choice-btn" data-choice="行商之子">💰 行商之子，财运亨通</button>
                    <button class="choice-btn" data-choice="战乱流民">⚔️ 战乱流民，乱世求生</button>
                `;

                // 重置场景图片
                const initialImagePrompt = "A panoramic view of ancient China during the Three Kingdoms period, with vast plains, rolling hills, a bustling market town, a fortified military camp, and a serene scholarly retreat, ink wash painting or traditional Chinese painting style.";
                try {
                    await generateImage(initialImagePrompt);
                } catch (error) {
                    console.error("重置时图片加载失败:", error);
                }

                updateUI();
                alert('新一局乱世征程已开启！');
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            apiUrlInput.value = localStorage.getItem('customApiUrl') || '';
            apiKeyInput.value = localStorage.getItem('customApiKey') || '';
            
            await fetchModels();
            
            choicesContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    const button = e.target.closest('button');
                    handleChoice(button.dataset.choice, button.textContent.trim());
                }
            });

            saveApiBtn.addEventListener('click', saveApiSettings);
            clearApiBtn.addEventListener('click', clearApiSettings);
            
            // 游戏控制按钮事件
            document.getElementById('reset-game-btn').addEventListener('click', resetGame);
            
            // 自定义输入提交事件
			submitCustomChoiceBtn.addEventListener('click', () => {
				handleCustomChoice();
				customChoiceInput.value = ''; // 清空输入框
			});
			
			customChoiceInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') {
				e.preventDefault(); // 防止表单默认行为（尤其移动端）
				handleCustomChoice();
				customChoiceInput.value = ''; // 清空输入框

				// 移动端自动关闭键盘
				customChoiceInput.blur();
			}
		});
            
            // 检查是否是本地文件访问
            const isLocalFile = window.location.protocol === 'file:';
            
            // 更新API设置提示文本
            const apiHint = document.getElementById('api-settings-hint');
            if (isLocalFile) {
                apiHint.innerHTML = '⚠️ <strong>本地文件访问模式</strong>：必须配置自定义API才能使用游戏功能。<br>请填写您的AI API信息（配置仅存于浏览器本地，安全可靠）：';
                apiHint.style.color = '#ff6b6b';
                // 更新占位符文本
                apiUrlInput.placeholder = 'API URL (必填，如: https://api.openai.com/v1)';
                apiKeyInput.placeholder = 'API Key (必填)';
            }
            
            // 尝试加载保存的游戏状态
            const hasLoadedSave = loadGameState();
            
            if (!hasLoadedSave) {
                // 如果没有保存的状态，显示初始场景
				/**
                if (!isLocalFile) {
                    showLoading(true);
                }*/
                //const initialImagePrompt = "A vast and mystical Chinese cultivation world, with towering mountains shrouded in mist, a majestic sword sect, a dark shadowy demonic sect, and a tranquil alchemist's pavilion, ink wash painting style";
                   if (enableImageRendering) {
					try {
						await generateImage(initialImagePrompt);
					} catch (error) {
						console.error("初始图片加载失败:", error);
					}
				}
            } else {
                // 如果加载了保存的状态，但没有场景图片，则生成初始图片
                if (!sceneImg.src || sceneImg.src === window.location.href || sceneImg.src.includes('file://')) {
                    const initialImagePrompt = "A vast and mystical Chinese cultivation world, with towering mountains shrouded in mist, a majestic sword sect, a dark shadowy demonic sect, and a tranquil alchemist's pavilion, ink wash painting style";
                    try {
                        await generateImage(initialImagePrompt);
                    } catch (error) {
                        console.error("初始图片加载失败:", error);
                    }
                }
            }
            
            updateUI();
        });

        // 处理自定义输入
        function handleCustomChoice() {
            const customText = customChoiceInput.value.trim();
            if (!customText) {
                alert('请输入你的行动指令');
                return;
            }
            
            // 添加到大事记
            gameState.turn++;
            gameState.adventureLog.push({ turn: gameState.turn, entry: `你决定: ${customText}` });
            updateUI();
            
            // 加载场景
            loadScene('custom', customText);
        }

        // 加载场景 - 现在完全由AI驱动
        async function loadScene(sceneKey, playerChoiceText = null) {
            showLoading(true);
            
            try {
                const scene = await generateAdventure(sceneKey, playerChoiceText);
                if (!scene) {
                    throw new Error('AI未能生成有效场景');
                }

                // 在状态更新后检查游戏是否结束
                if (gameState.health <= 0) {
                    updateUI(); // 最后一次更新UI以显示0 HP
                    storyText.textContent = scene.text + "\n\n你的气息逐渐微弱，眼前一黑，意识沉入了无尽的黑暗... 你的冒险结束了。";
                    choicesContainer.innerHTML = '';
                    const restartBtn = document.createElement('button');
                    restartBtn.className = 'choice-btn';
                    restartBtn.textContent = '🔄 重新开始';
                    restartBtn.onclick = resetGame;
                    choicesContainer.appendChild(restartBtn);
                    choicesContainer.style.gridTemplateColumns = '1fr';
                    showLoading(false);
                    saveGameState(); // 保存游戏结束的状态
                    return;
                }

                gameState.currentScene = sceneKey;
                storyText.textContent = scene.text;
                renderChoices(scene.choices);
                
                // 等待图片加载完成后再保存游戏进度
                try {
                    await generateImage(scene.imagePrompt);
                    // 在所有DOM更新（包括图片）完成后保存游戏进度
                    saveGameState();
                } catch (error) {
                    console.error("图片生成失败，但仍保存游戏进度:", error);
                    // 即使图片加载失败，也要保存游戏进度
                    saveGameState();
                }
				
				updateUI();
            } catch (error) {
                console.error("冒险生成失败的详细错误:", error);
                showLoading(false);
                
                let errorMessage = error instanceof Error ? error.message : JSON.stringify(error);
                
                // 根据错误类型提供不同的提示
                if (errorMessage.includes('timeout') || errorMessage.includes('TIMEOUT')) {
                    alert(`⏰ 请求超时：AI服务响应较慢，请稍后重试。\n\n建议：\n1. 检查网络连接\n2. 稍等片刻后重新选择\n3. 如持续出现，可尝试刷新页面`);
                } else if (errorMessage.includes('API key')) {
                    alert(`🔑 API配置错误：请检查API密钥设置。\n\n如果使用默认后端API，请联系管理员。\n如果使用自定义API，请检查API设置。`);
                } else if (errorMessage.includes('500') || errorMessage.includes('502') || errorMessage.includes('503')) {
                    alert(`🔧 服务器错误：AI服务暂时不可用。\n\n建议：\n1. 稍后重试\n2. 检查API服务状态\n3. 如持续出现，请联系技术支持`);
                } else {
                    alert(`❌ 冒险生成失败: ${errorMessage}\n\n请检查：\n1. 网络连接是否正常\n2. API设置是否正确\n3. 查看浏览器控制台获取详细信息`);
                }
            }
        }

        // 使用后端API生成冒险
        async function generateAdventure(currentSceneKey, playerChoiceText) {
            // 检查是否是本地文件访问
            const isLocalFile = window.location.protocol === 'file:';
            
            // 本地文件访问时必须使用自定义API，否则优先使用后端API
            let useCustomApi = isLocalFile || (localStorage.getItem('customApiUrl') && localStorage.getItem('customApiKey'));
            let model = localStorage.getItem('customModel') || ''; // 空字符串表示使用后端默认模型
            
            // 本地访问时如果没有配置自定义API，提示用户
            if (isLocalFile && (!localStorage.getItem('customApiUrl') || !localStorage.getItem('customApiKey'))) {
                throw new Error('本地文件访问模式需要配置自定义API。请在页面下方的"API设置"中填写您的API URL和密钥。');
            }
            
            const previousSceneText = storyText.textContent;
            
            // 修改提示词，强调生命值只在战斗时变化
            const prompt = `你是一个顶级的文字冒险游戏引擎，负责动态生成一个连贯、有趣且节奏合理的三国故事。玩家的性别将在游戏开始时随机生成，并且在玩家选择出身的时候告知性别。模拟东汉末年至三国时期（公元184-280年）的人生历程，从出生到死亡，探索乱世、制度与人情如何塑造个人命运。体验黄巾起义等关键历史事件与重大战役。

## 核心原则与循环打破 (最高优先级)
0.  **中文回复:** 游戏内容必须以中文给出。
1.  **事件驱动:** 聚焦具体战役、谋略、对话、人物关系、局势演变。
2.  **剧情深化:** 优先扩展当前事件与已有角色关系，**避免轻易引入新人物**。
3.  **系统整合:** 玩家的**战法/计策**（${gameState.skills.map(s => s.name).join('、') || '无'}）与**物品行囊**须自然嵌入剧情与选项中。
4.  **剧情推动:** 每段文本结尾必须推动事情发展，**严禁使用引导语**。
5.  **生命值规则:** 非战斗、非负伤、非生病情节**不得变更体力 (health)**。
6.  **循环打破机制 (LOOP BREAKER):**
    * 分析最近5条**大事记**。
    * 识别重复循环（如缠斗同敌、围城不克）。
    * **强制推进事件**（敌败、援军、内讧、奇谋突袭等）。
    * 提供**新阶段行为**（如“清点战果”、“休整军队”、“转战他地”）。
7.  **养成规则:** 16岁之前不发生战斗，**专注养成**，包括人物关系培养、属性增长及道具获取。
8.  **禁止原则:** **严禁出现任何玄幻及超出当前时代的科技**。严格输出游戏内容描述，不额外解释说明。
9.  **检验原则:** 对玩家的自定义输入进行校验，**不允许违反上述规定**。若违反，则判定选择无效，当前回合继续推动时间发展。

**剧情节奏与时间流逝:**
- 当前为游戏第 **${gameState.turn} 回合**，即玩家 **${gameState.age} 岁**
- 每回合一年，关键事件不得拖延超过10回合

**玩家成长与系统设定:**
- **属性体系:**
    - 体力 (Health): 战斗和特殊事件消耗，上限100。
    - 武力 (Attack): 影响战斗胜负。
    - 智力 (Defense): 影响谋略成功率，计策效果。
    - 统率 (Agility): 影响军队指挥，行军速度。
    - 魅力 (Charm): 影响招募人才，外交成功率。
    - 铜钱 (Coins): 财富，用于购买、建设。
    - 声望 (Reputation): 影响力，解锁高阶事件，影响人脉。
    - 身份 (Identity): 玩家当前身份，如布衣、伍长、县尉、郡守等，与官职体系结合。
- **人生阶段：**
  - 0–6 岁（出身）→ 确定资源
  - 7–13 岁（启蒙）→ 求师学艺
  - 14–19 岁（少年）→ 从军、交友、择主
  - 20–40 岁（壮年）→ 封侯、掌权、征战、联姻
  - 41–60 岁（盛年）→ 扶主、传承、归隐
  - 60+ 岁（老年）→ 谋后事、终结局
  
【核心系统】
A) 争雄（军事线）：应征入伍/募兵起事/依附军阀。需经营资源，凭战功晋升
B) 谋国（内政线）：担任幕僚或官吏，治理辖区，推行屯田。需平衡民心赋税与人才
C) 纵横（外交谋略）：游说诸侯、缔结盟约、联姻离间。需信誉与情报支持
D) 世家大族：宗族联姻、举荐人才、土地兼并、管理部曲。面临族内纷争与外患
E) 庶民生涯：耕作贩运、缴纳赋税、服徭役。需应对饥荒瘟疫与盗匪兵祸
F) 挚交与挚爱（情感羁绊）:在乱世中，真挚的情谊与爱情能成为生存的动力或软肋。通过互动建立深厚关系，获得特殊支持或面临情感抉择

**历史模拟与身份演变机制：**
- 关键历史事件将随时间推进（如黄巾起义、董卓入京、赤壁之战）
- 玩家选择可介入或避让，每年根据回合推进演变局势
- 身份可随事件变化（如平民 → 偏将军 → 州牧 → 丞相 → 帝王）


**玩家当前状态:**
- **身份:** 等级 ${gameState.level}（如布衣、县尉、郡守、丞相、帝王）
- **属性:** 体力 ${gameState.health}/${gameState.maxHealth}，铜钱 ${gameState.coins}，声望 ${gameState.reputation}
- **最近大事记:** ${gameState.adventureLog.slice(-5).map(log => `回合 ${log.turn}: ${log.entry}`).join('; ') || '无'}
- **前情提要:** "${previousSceneText.slice(-250)}"
- **玩家行动:** "${playerChoiceText}"

**输出规范（严格JSON格式）:**
json
{
  "text": "纯粹的事件描述(150-300字)。结尾为高潮或转折。",
  "imagePrompt": "Traditional Chinese painting, Three Kingdoms period, [与'text'内容高度相关的具体场景、人物、动作关键词]",
  "choices": [
    {"text": "符合当前情景的行动1", "target": "action_1"},
    {"text": "基于玩家战法或计策的行动2", "target": "action_2"},
    {"text": "可能改变当前局势的冒险行动3", "target": "action_3"}
  ],
 "gameState": {
        "health": <当前体力值，例如 90>,
        "attack": <当前武力值，例如 6>,
        "defense": <当前智力值，例如 5>,
        "agility": <当前统率值，例如 5>,
        "charm": <当前魅力值，例如 5>,
        "coins": <当前铜钱数，例如 120>,
        "reputation": <当前声望值，例如 10>,
        "identity": "<当前身份，例如 游侠>",
        "skills": [
            {"name": "新获得的战法名称", "description": "战法描述", "icon": "fa-solid fa-star"},
            // ... 其他技能
        ],
        "items": [
            "新获得的物品名称",
            // ... 其他物品
        ],
        "achievements": [
            {"id": "achievement_id", "unlocked": true},
            // ... 其他解锁的成就
        ]
    },
  "itemUpdates": {"add": [], "remove": []},
  "unlockAchievements": [],
  "logEntry": "对本次事件的高度概括（20字以内）"
}`;

            let response;
            
            if (useCustomApi) {
                // 使用用户自定义的API设置
                const apiUrl = localStorage.getItem('customApiUrl');
                const apiKey = localStorage.getItem('customApiKey');
                const finalApiUrl = apiUrl.trim() + '/chat/completions';

                response = await fetch(finalApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: prompt }],
                        response_format: { type: "json_object" }
                    })
                });
            } else {
                // 使用后端API（安全）
                response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: model
                    })
                });
            }

            if (!response.ok) {
                throw new Error(`API 请求失败: ${response.status} ${await response.text()}`);
            }

            const data = await response.json();
            console.log("API返回的原始数据:", data);
            
            // 添加详细的调试信息
            if (data.usage) {
                console.log("Token使用情况:", data.usage);
                if (data.usage.completion_tokens >= 3900) {
                    console.warn("警告：响应接近token限制，可能被截断");
                }
            }
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('API返回数据格式错误：缺少choices或message字段');
            }
            
            let contentString = data.choices[0].message.content;
            console.log("AI返回的原始内容:", contentString);
            
            if (!contentString || contentString.trim() === '') {
                throw new Error('AI返回的内容为空');
            }
            
            // 尝试提取JSON代码块
            const match = contentString.match(/```json\s*([\s\S]*?)\s*```/);
            if (match) {
                contentString = match[1];
                console.log("提取的JSON内容:", contentString);
            }

            // 尝试修复不完整的JSON
            function tryFixIncompleteJson(jsonStr) {
				 jsonStr = jsonStr.replace(/undefined/g, 'null')
								  .replace(/<!--[\s\S]*?-->/g, '');
				 jsonStr = jsonStr.trim();
                
                // 尝试找到最后一个有效的JSON字符（'}' 或 ']' 或 '"'）
                const lastBrace = jsonStr.lastIndexOf('}');
                const lastBracket = jsonStr.lastIndexOf(']');
                const lastQuote = jsonStr.lastIndexOf('"');
                const lastNumber = jsonStr.search(/[0-9]\s*$/);

                const lastValidCharIndex = Math.max(lastBrace, lastBracket, lastQuote, lastNumber);

                // 如果字符串在最后一个有效字符后还有内容，说明可能被截断了
                if (lastValidCharIndex !== -1 && lastValidCharIndex < jsonStr.length - 1) {
                    // 截断到最后一个有效字符
                    jsonStr = jsonStr.substring(0, lastValidCharIndex + 1);
                }
                
                // 重新计算括号和花括号的配平
                let openBraces = (jsonStr.match(/{/g) || []).length;
                let closeBraces = (jsonStr.match(/}/g) || []).length;
                let openBrackets = (jsonStr.match(/\[/g) || []).length;
                let closeBrackets = (jsonStr.match(/\]/g) || []).length;

                // 闭合未闭合的括号
                while (openBrackets > closeBrackets) {
                    jsonStr += ']';
                    closeBrackets++;
                }
                
                // 闭合未闭合的花括号
                while (openBraces > closeBraces) {
                    jsonStr += '}';
                    closeBraces++;
                }

                return jsonStr;
            }

            try {
                let content;
                try {
                    content = JSON.parse(contentString);
                } catch (firstError) {
                    console.log("首次JSON解析失败，尝试修复:", firstError.message);
                    const fixedJsonString = tryFixIncompleteJson(contentString);
                    console.log("修复后的JSON:", fixedJsonString);
                    content = JSON.parse(fixedJsonString);
                    console.log("修复成功！");
                }
                console.log("解析成功的content:", JSON.stringify(content, null, 2));
                
                // 验证必需字段
                if (!content.text) {
                    console.warn("警告：缺少text字段，使用默认值");
                    content.text = "你继续在这个神秘的世界中探索...";
                }
                if (!content.imagePrompt) {
                    console.warn("警告：缺少imagePrompt字段，使用默认值");
                    content.imagePrompt = "A mystical Chinese cultivation world scene";
                }
                if (!content.choices || !Array.isArray(content.choices)) {
                    console.warn("警告：缺少choices字段，使用默认值");
                    content.choices = [
                        { text: "继续探索", target: "continue" },
                        { text: "休息片刻", target: "rest" }
                    ];
                }
                if (!content.gameStateUpdates) {
                    content.gameStateUpdates = {};
                }
                if (!content.itemUpdates) {
                    content.itemUpdates = { add: [], remove: [] };
                }
                if (!content.unlockAchievements) {
                    content.unlockAchievements = [];
                }
                if (!content.logEntry) {
                    content.logEntry = "继续冒险...";
                }

		if (content.gameState) {
			const updates = content.gameState;
			
			// 直接设置数值属性
			['health', 'maxHealth', 'attack', 'defense', 'agility', 'charm', 'coins', 'reputation', 'level'].forEach(key => {
				if (updates[key] !== undefined) {
					gameState[key] = Number(updates[key]);
				}
			});
			
			// 更新身份
			if (updates.identity) {
				gameState.identity = updates.identity;
			}
			
			// 更新技能列表（完全替换）
			if (updates.skills && Array.isArray(updates.skills)) {
				gameState.skills = updates.skills.map(skill => ({
					name: skill.name,
					description: skill.description || "新习得的技能",
					icon: skill.icon || "fa-solid fa-star"
				}));
			}
			
			// 修复物品更新逻辑 - 处理字符串数组
			if (updates.items && Array.isArray(updates.items)) {
				gameState.items = updates.items.map(item => {
					// 处理字符串形式的物品
					if (typeof item === 'string') {
						return {
							id: item.toLowerCase().replace(/\s/g, '_'),
							name: item
						};
					}
					// 处理对象形式的物品
					return {
						id: item.name.toLowerCase().replace(/\s/g, '_'),
						name: item.name
					};
				});
			}
			
			// 更新成就状态
			if (updates.achievements && Array.isArray(updates.achievements)) {
				updates.achievements.forEach(achUpdate => {
					const achievement = gameState.achievements.find(a => a.id === achUpdate.id);
					if (achievement) {
						achievement.unlocked = achUpdate.unlocked;
					}
				});
			}
		}
                if (content.itemUpdates) {
                    if (content.itemUpdates.add && Array.isArray(content.itemUpdates.add)) {
                        content.itemUpdates.add.forEach(newItemName => {
                            if (typeof newItemName === 'string') {
                                gameState.items.push({ id: newItemName.toLowerCase().replace(/\s/g, '_'), name: newItemName });
                            }
                        });
                    }
                    if (content.itemUpdates.remove) {
                        content.itemUpdates.remove.forEach(itemIdToRemove => {
                            gameState.items = gameState.items.filter(item => item.id !== itemIdToRemove);
                        });
                    }
                }

                if (content.unlockAchievements && Array.isArray(content.unlockAchievements)) {
                    content.unlockAchievements.forEach(achIdToUnlock => {
                        const achievement = gameState.achievements.find(a => a.id === achIdToUnlock);
                        if (achievement && !achievement.unlocked) {
                            achievement.unlocked = true;
                        }
                    });
                }
                
                // 自动检查技能相关成就
                const skillCount = gameState.skills.length;
                if (skillCount >= 1) {
                    const firstSkillAch = gameState.achievements.find(a => a.id === 'first_skill');
                    if (firstSkillAch && !firstSkillAch.unlocked) {
                        firstSkillAch.unlocked = true;
                        console.log("解锁成就: 初窥门径");
                    }
                }
                if (skillCount >= 5) {
                    const skillMasterAch = gameState.achievements.find(a => a.id === 'skill_master');
                    if (skillMasterAch && !skillMasterAch.unlocked) {
                        skillMasterAch.unlocked = true;
                        console.log("解锁成就: 技艺精湛");
                    }
                }
                
                // 检查法术类技能数量
                const spellSkills = gameState.skills.filter(skill =>
                    skill.name.includes('术') || skill.name.includes('法') || skill.name.includes('咒')
                );
                if (spellSkills.length >= 3) {
                    const spellCasterAch = gameState.achievements.find(a => a.id === 'spell_caster');
                    if (spellCasterAch && !spellCasterAch.unlocked) {
                        spellCasterAch.unlocked = true;
                        console.log("解锁成就: 法术大师");
                    }
                }
                
                if(content.logEntry && typeof content.logEntry === 'string') {
                    gameState.turn++;
                    gameState.adventureLog.push({ turn: gameState.turn, entry: content.logEntry });
                }

                updateUI();
                
                return content;
            } catch (e) {
                console.error("JSON解析失败:", e);
                console.error("尝试解析的内容:", contentString);
                
                // 尝试从原始内容中提取文本信息
                let extractedText = "抱歉，AI响应解析失败。你发现自己站在一个神秘的地方，周围云雾缭绕，似乎有无数的可能性等待着你去探索。";
                
                // 尝试从截断的JSON中提取text字段
                const textMatch = contentString.match(/"text":\s*"([^"]*(?:\\.[^"]*)*)/);
                if (textMatch && textMatch[1]) {
                    extractedText = textMatch[1].replace(/\\"/g, '"').replace(/\n/g, '\n');
                    console.log("从截断的JSON中提取到文本:", extractedText);
                }
                
                // 如果JSON解析失败，生成一个智能的fallback响应
                const fallbackContent = {
                    text: extractedText,
                    imagePrompt: "A mystical Chinese cultivation world with swirling mists and ancient mountains, ink wash painting style",
                    choices: [
                        { text: "🔄 重新尝试", target: "retry" },
                        { text: "🏠 返回起点", target: "start" },
                        { text: "继续探索", target: "continue" }
                    ],
                    gameStateUpdates: {},
                    itemUpdates: { add: [], remove: [] },
                    unlockAchievements: [],
                    logEntry: "遇到了一些技术问题，但冒险仍在继续..."
                };
                
                console.log("使用备用响应:", fallbackContent);
                return fallbackContent;
            }
        }

        async function generateImage(prompt) {
		
		if (!enableImageRendering) {
        console.log('图片渲染未开启，跳过图片生成。');
        sceneImg.src = '';  // 可选清空图像
        showLoading(false);
        return Promise.resolve(null);
		}

            return new Promise(async (resolve, reject) => {
                try {
                    sceneImg.style.opacity = 0.5;
                    
                    // 检查是否是本地文件访问
                    const isLocalFile = window.location.protocol === 'file:';
                    let imageUrl;
                    
                    if (isLocalFile) {
                        // 本地文件访问时直接使用pollinations API
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true&width=800&height=600&model=flux`;
                    } else {
                        // 通过后端API生成图片
                        const response = await fetch('/api/image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                prompt: prompt,
                                width: 800,
                                height: 600,
                                nologo: true,
                                model: 'flux'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`图片生成API请求失败: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        if (!data.success || !data.imageUrl) {
                            throw new Error('图片生成失败');
                        }
                        
                        imageUrl = data.imageUrl;
                        console.log('图片生成成功:', data);
                    }
                    
                    // 预加载图片
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        sceneImg.src = imageUrl;
                        sceneImg.style.opacity = 1;
                        showLoading(false);
                        resolve(imageUrl);
                    };
                    
                    img.onerror = () => {
                        console.error("图片加载失败，使用备用图片");
                        // 使用备用图片URL
                        const fallbackUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMWExYTJlIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzRlY2RjNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuS/ruS7meS4lueVjO+8muS6kea4uuS7meWcnzwvdGV4dD4KPC9zdmc+';
                        sceneImg.src = fallbackUrl;
                        sceneImg.style.opacity = 1;
                        showLoading(false);
                        resolve(fallbackUrl);
                    };
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('图片生成错误:', error);
                    // 使用备用图片
                    const fallbackUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMWExYTJlIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzRlY2RjNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuS/ruS7meS4lueVjO+8muS6kea4uuS7meWcnzwvdGV4dD4KPC9zdmc+';
                    sceneImg.src = fallbackUrl;
                    sceneImg.style.opacity = 1;
                    showLoading(false);
                    resolve(fallbackUrl);
                }
            });
        }
        
        function renderChoices(choices) {
            choicesContainer.innerHTML = '';
            if (!choices || choices.length === 0) {
                const endButton = document.createElement('button');
                endButton.className = 'choice-btn';
                endButton.textContent = '本次冒险暂告一段落，刷新页面重新开始。';
                endButton.onclick = () => window.location.reload();
                choicesContainer.appendChild(endButton);
                return;
            }
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.dataset.choice = choice.target;
                button.textContent = choice.text;
                choicesContainer.appendChild(button);
            });
        }
        
        function handleChoice(choiceTarget, choiceText) {
            const firstChoiceAch = gameState.achievements.find(a => a.id === 'first_choice');
            if (firstChoiceAch && !firstChoiceAch.unlocked) {
                firstChoiceAch.unlocked = true;
            }
            loadScene(choiceTarget, choiceText);
        }

        function showLoading(show) {
            loadingOverlay.classList.toggle('active', show);
        }

        function updateUI() {
            if (!Array.isArray(gameState.adventureLog)) {
                gameState.adventureLog = [];
            }

            healthBar.style.width = `${(gameState.health / gameState.maxHealth) * 100}%`;
            healthText.textContent = `体力: ${gameState.health}/${gameState.maxHealth}`;
            coinsEl.textContent = gameState.coins;
            reputationEl.textContent = gameState.reputation;

            // 更新身份/地位显示
            if (gameState.level > 30) {
                levelEl.textContent = '帝王';
            } else if (gameState.level > 25) {
                levelEl.textContent = '丞相/大将军';
            } else if (gameState.level > 20) {
                levelEl.textContent = '州牧/太守';
            } else if (gameState.level > 15) {
                levelEl.textContent = '郡守/刺史';
            } else if (gameState.level > 10) {
                levelEl.textContent = '校尉/都尉';
            } else if (gameState.level > 5) {
                levelEl.textContent = '县令/亭长';
            } else if (gameState.level > 1) {
                levelEl.textContent = '乡绅/里正';
            } else {
                levelEl.textContent = '布衣';
            }
            levelEl.title = `等级: ${gameState.level}`;

            attackEl.textContent = gameState.attack;
            defenseEl.textContent = gameState.defense;
            agilityEl.textContent = gameState.agility;
            charmEl.textContent = gameState.charm;

            skillsList.innerHTML = '';
            if (!gameState.skills || gameState.skills.length === 0) {
                skillsList.innerHTML = '<div>尚未习得任何战法或计策</div>';
            } else {
                gameState.skills.forEach(skill => {
                    const skillItem = document.createElement('div');
                    skillItem.className = 'skill-item';
                    skillItem.innerHTML = `<div class="skill-name"><i class="${skill.icon || 'fa-solid fa-book'}"></i> ${skill.name}</div><div class="skill-description">${skill.description}</div>`;
                    skillsList.appendChild(skillItem);
                });
            }

			itemsGrid.innerHTML = '';
            if (!gameState.items || gameState.items.length === 0) {
                itemsGrid.innerHTML = '<div class="list-item">行囊空空...</div>';
            } else {
                // 合并相同物品
                const itemMap = new Map();
                gameState.items.forEach(item => {
                    const itemName = typeof item === 'string' ? item : item.name;
                    if (itemMap.has(itemName)) {
                        const existing = itemMap.get(itemName);
                        existing.count += 1;
                    } else {
                        itemMap.set(itemName, {
                            name: itemName,
                            count: 1
                        });
                    }
                });
                
                // 渲染合并后的物品
                itemMap.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'list-item';
                    itemEl.innerHTML = `
                        <div class="list-icon">
                            <i class="fa-solid fa-box"></i>
                        </div>
                        <div class="list-content">
                            <div class="list-name">
                                ${item.name}
                                <span class="list-count">x${item.count}</span>
                            </div>
                        </div>
                    `;
                    itemsGrid.appendChild(itemEl);
                });
            }

            achievementList.innerHTML = '';
            const unlockedAchievements = gameState.achievements.filter(a => a.unlocked);
            if (unlockedAchievements.length === 0) {
                achievementList.innerHTML = '<div>尚无功绩可言</div>';
            } else {
                unlockedAchievements.forEach(ach => {
                    const achEl = document.createElement('div');
                    achEl.className = 'achievement-text';
                    achEl.textContent = `• ${ach.text}`;
                    achievementList.appendChild(achEl);
                });
            }

            adventureLogEl.innerHTML = '';
            if (!gameState.adventureLog || gameState.adventureLog.length === 0) {
                adventureLogEl.innerHTML = '<div>天下大事，由你书写...</div>';
            } else {
                gameState.adventureLog.slice().reverse().forEach(log => {
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry';
                    logEl.innerHTML = `<span class="log-turn">[回合 ${log.turn}]</span> ${log.entry}`;
                    adventureLogEl.appendChild(logEl);
                });
            }
        }
        
        async function fetchModels() {
            const modelSelect = document.getElementById('model-input');
            modelSelect.innerHTML = '<option value="">加载中...</option>';
            
            try {
                // 检查是否是本地文件访问
                const isLocalFile = window.location.protocol === 'file:';
                let defaultModelName = 'DeepSeek-R1-0528';
                
                // 只有在非本地文件访问时才尝试获取后端配置
                if (!isLocalFile) {
                    try {
                        const configResponse = await fetch('/api/config');
                        if (configResponse.ok) {
                            const config = await configResponse.json();
                            defaultModelName = config.defaultModel;
                        }
                    } catch (e) {
                        console.log('无法获取后端配置，使用默认值');
                    }
                }
                
                // 本地文件访问时必须使用自定义API
                let useCustomApi = isLocalFile || (apiUrlInput.value.trim() && apiKeyInput.value.trim());
                let response;
                
                if (useCustomApi && apiUrlInput.value.trim() && apiKeyInput.value.trim()) {
                    // 使用用户自定义的API设置
                    let apiUrl = apiUrlInput.value.trim();
                    let apiKey = apiKeyInput.value.trim();

                    if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
                    const modelsUrl = `${apiUrl}/models`;

                    response = await fetch(modelsUrl, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                } else if (!isLocalFile) {
                    // 使用后端API（仅在非本地文件访问时）
                    response = await fetch('/api/models');
                } else {
                    // 本地文件访问但没有配置API
                    throw new Error('本地访问需要配置自定义API');
                }

                if (!response.ok) {
                    throw new Error(`获取模型列表失败: ${response.status}`);
                }

                const data = await response.json();
                const models = data.data
                    .filter(model => model.id)
                    .sort((a, b) => a.id.localeCompare(b.id));

                // 添加默认选项
                let optionsHtml = isLocalFile ?
                    '<option value="">请选择模型</option>' :
                    `<option value="">使用后端默认模型 (${defaultModelName})</option>`;
                optionsHtml += models
                    .map(model => `<option value="${model.id}">${model.id}</option>`)
                    .join('');
                
                modelSelect.innerHTML = optionsHtml;
                
                const savedModel = localStorage.getItem('customModel');
                if (savedModel !== null && (savedModel === '' || models.some(m => m.id === savedModel))) {
                    modelSelect.value = savedModel;
                }
            } catch (error) {
                console.error('获取模型列表失败:', error);
                const isLocalFile = window.location.protocol === 'file:';
                if (isLocalFile) {
                    modelSelect.innerHTML = '<option value="">请先配置API设置</option><option value="DeepSeek-R1-0528">DeepSeek-R1-0528</option>';
                } else {
                    modelSelect.innerHTML = `<option value="">使用后端默认模型 (${defaultModelName})</option><option value="DeepSeek-R1-0528">DeepSeek-R1-0528</option>`;
                }
            }
        }

        function saveApiSettings() {
            localStorage.setItem('customApiUrl', apiUrlInput.value);
            localStorage.setItem('customModel', modelInput.value);
            localStorage.setItem('customApiKey', apiKeyInput.value);
            fetchModels();
            alert('API设置已保存!');
        }

        function clearApiSettings() {
            localStorage.removeItem('customApiUrl');
            localStorage.removeItem('customModel');
            localStorage.removeItem('customApiKey');
            apiUrlInput.value = '';
            modelInput.value = '';
            apiKeyInput.value = '';
            alert('API设置已清除!');
        }
    </script>
</body>
</html>